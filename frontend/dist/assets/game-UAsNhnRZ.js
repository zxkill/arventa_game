import{S as ts,c as di,i as hi,f as on,d as is,r as ns,D as ui,a as ie,T as ln,E as $,b as Ct,e as ss,l as rs,g as qe,h as as,j as os,k as Q,m as Xe,n as ls,o as cs,p as ds,q as it,s as Di,t as wt,u as qt,v as nt,w as cn,x as Ot,y as dn,z as be,A as hs,B as fi,C as us,F as st,G as gi,H as ce,I as H,J as ee,K as Ke,L as hn,M as fs,N as un,O as Ce,P as gs,Q as _s,R as mt,U as yt,V as _i,W as fn,X as ms,Y as ys,Z as ps,_ as J,$ as Es,a0 as rt,a1 as Xt,a2 as vs,a3 as mi,a4 as Ts,a5 as Jt,a6 as gn,a7 as xs,a8 as ei,a9 as yi,aa as ws,ab as ue,ac as oe,ad as Lt,ae as C,af as U,ag as Mi,ah as bs,ai as Cs,aj as _n,ak as Be,al as mn,am as Ls,an as at,ao as Rs,ap as et,aq as Ss,ar as As,as as yn,at as pi,au as Is,av as Ei,aw as Fi,ax as Ps,ay as pn,az as Ds,aA as Oi,aB as pt,aC as ot,aD as Ms,aE as lt,aF as Fs,aG as En,aH as Os,aI as vn,aJ as Tn,aK as ks,aL as Ns,aM as xn,aN as ki,aO as we,aP as Us,aQ as zs,aR as Et,aS as Ni,aT as Ui,aU as Gs,aV as qs,aW as Xs,aX as Ks,aY as pe,aZ as tt,a_ as Bs,a$ as zi,b0 as Kt,b1 as Ie,b2 as Ye,b3 as Gi,b4 as $s,b5 as Re,b6 as vt}from"./api-BXiN5zbP.js";class vi extends ts{constructor(e,t,i){super(),i!==void 0&&t===void 0?this.setFlatCoordinates(i,e):(t=t||0,this.setCenterAndRadius(e,t,i))}clone(){const e=new vi(this.flatCoordinates.slice(),void 0,this.layout);return e.applyProperties(this),e}closestPointXY(e,t,i,s){const r=this.flatCoordinates,a=e-r[0],o=t-r[1],l=a*a+o*o;if(l<s){if(l===0)for(let c=0;c<this.stride;++c)i[c]=r[c];else{const c=this.getRadius()/Math.sqrt(l);i[0]=r[0]+c*a,i[1]=r[1]+c*o;for(let d=2;d<this.stride;++d)i[d]=r[d]}return i.length=this.stride,l}return s}containsXY(e,t){const i=this.flatCoordinates,s=e-i[0],r=t-i[1];return s*s+r*r<=this.getRadiusSquared_()}getCenter(){return this.flatCoordinates.slice(0,this.stride)}computeExtent(e){const t=this.flatCoordinates,i=t[this.stride]-t[0];return di(t[0]-i,t[1]-i,t[0]+i,t[1]+i,e)}getRadius(){return Math.sqrt(this.getRadiusSquared_())}getRadiusSquared_(){const e=this.flatCoordinates[this.stride]-this.flatCoordinates[0],t=this.flatCoordinates[this.stride+1]-this.flatCoordinates[1];return e*e+t*t}getType(){return"Circle"}intersectsExtent(e){const t=this.getExtent();if(hi(e,t)){const i=this.getCenter();return e[0]<=i[0]&&e[2]>=i[0]||e[1]<=i[1]&&e[3]>=i[1]?!0:on(e,this.intersectsCoordinate.bind(this))}return!1}setCenter(e){const t=this.stride,i=this.flatCoordinates[t]-this.flatCoordinates[0],s=e.slice();s[t]=s[0]+i;for(let r=1;r<t;++r)s[t+r]=e[r];this.setFlatCoordinates(this.layout,s),this.changed()}setCenterAndRadius(e,t,i){this.setLayout(i,e,0),this.flatCoordinates||(this.flatCoordinates=[]);const s=this.flatCoordinates;let r=is(s,0,e,this.stride);s[r++]=s[0]+t;for(let a=1,o=this.stride;a<o;++a)s[r++]=s[a];s.length=r,this.changed()}getCoordinates(){return null}setCoordinates(e,t){}setRadius(e){this.flatCoordinates[this.stride]=this.flatCoordinates[0]+e,this.changed()}rotate(e,t){const i=this.getCenter(),s=this.getStride();this.setCenter(ns(i,0,i.length,s,e,t,i)),this.changed()}}class Ws{constructor(e){this.highWaterMark=e!==void 0?e:2048,this.count_=0,this.entries_={},this.oldest_=null,this.newest_=null}deleteOldest(){const e=this.pop();e instanceof ui&&e.dispose()}canExpireCache(){return this.highWaterMark>0&&this.getCount()>this.highWaterMark}expireCache(e){for(;this.canExpireCache();)this.deleteOldest()}clear(){for(;this.oldest_;)this.deleteOldest()}containsKey(e){return this.entries_.hasOwnProperty(e)}forEach(e){let t=this.oldest_;for(;t;)e(t.value_,t.key_,this),t=t.newer}get(e,t){const i=this.entries_[e];return ie(i!==void 0,"Tried to get a value for a key that does not exist in the cache"),i===this.newest_||(i===this.oldest_?(this.oldest_=this.oldest_.newer,this.oldest_.older=null):(i.newer.older=i.older,i.older.newer=i.newer),i.newer=null,i.older=this.newest_,this.newest_.newer=i,this.newest_=i),i.value_}remove(e){const t=this.entries_[e];return ie(t!==void 0,"Tried to get a value for a key that does not exist in the cache"),t===this.newest_?(this.newest_=t.older,this.newest_&&(this.newest_.newer=null)):t===this.oldest_?(this.oldest_=t.newer,this.oldest_&&(this.oldest_.older=null)):(t.newer.older=t.older,t.older.newer=t.newer),delete this.entries_[e],--this.count_,t.value_}getCount(){return this.count_}getKeys(){const e=new Array(this.count_);let t=0,i;for(i=this.newest_;i;i=i.older)e[t++]=i.key_;return e}getValues(){const e=new Array(this.count_);let t=0,i;for(i=this.newest_;i;i=i.older)e[t++]=i.value_;return e}peekLast(){return this.oldest_.value_}peekLastKey(){return this.oldest_.key_}peekFirstKey(){return this.newest_.key_}peek(e){var t;return(t=this.entries_[e])==null?void 0:t.value_}pop(){const e=this.oldest_;return delete this.entries_[e.key_],e.newer&&(e.newer.older=null),this.oldest_=e.newer,this.oldest_||(this.newest_=null),--this.count_,e.value_}replace(e,t){this.get(e),this.entries_[e].value_=t}set(e,t){ie(!(e in this.entries_),"Tried to set a value for a key that is used already");const i={key_:e,newer:null,older:this.newest_,value_:t};this.newest_?this.newest_.newer=i:this.oldest_=i,this.newest_=i,this.entries_[e]=i,++this.count_}setSize(e){this.highWaterMark=e}}const b={IDLE:0,LOADING:1,LOADED:2,ERROR:3,EMPTY:4};class Ti extends ln{constructor(e,t,i){super(),i=i||{},this.tileCoord=e,this.state=t,this.key="",this.transition_=i.transition===void 0?250:i.transition,this.transitionStarts_={},this.interpolate=!!i.interpolate}changed(){this.dispatchEvent($.CHANGE)}release(){this.state===b.ERROR&&this.setState(b.EMPTY)}getKey(){return this.key+"/"+this.tileCoord}getTileCoord(){return this.tileCoord}getState(){return this.state}setState(e){if(this.state!==b.ERROR&&this.state>e)throw new Error("Tile load sequence violation");this.state=e,this.changed()}load(){Ct()}getAlpha(e,t){if(!this.transition_)return 1;let i=this.transitionStarts_[e];if(!i)i=t,this.transitionStarts_[e]=i;else if(i===-1)return 1;const s=t-i+1e3/60;return s>=this.transition_?1:ss(s/this.transition_)}inTransition(e){return this.transition_?this.transitionStarts_[e]!==-1:!1}endTransition(e){this.transition_&&(this.transitionStarts_[e]=-1)}disposeInternal(){this.release(),super.disposeInternal()}}class wn extends Ti{constructor(e,t,i,s,r,a){super(e,t,a),this.crossOrigin_=s,this.src_=i,this.key=i,this.image_=new Image,s!==null&&(this.image_.crossOrigin=s),this.unlisten_=null,this.tileLoadFunction_=r}getImage(){return this.image_}setImage(e){this.image_=e,this.state=b.LOADED,this.unlistenImage_(),this.changed()}handleImageError_(){this.state=b.ERROR,this.unlistenImage_(),this.image_=js(),this.changed()}handleImageLoad_(){const e=this.image_;e.naturalWidth&&e.naturalHeight?this.state=b.LOADED:this.state=b.EMPTY,this.unlistenImage_(),this.changed()}load(){this.state==b.ERROR&&(this.state=b.IDLE,this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)),this.state==b.IDLE&&(this.state=b.LOADING,this.changed(),this.tileLoadFunction_(this,this.src_),this.unlisten_=rs(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))}unlistenImage_(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)}disposeInternal(){this.unlistenImage_(),this.image_=null,super.disposeInternal()}}function js(){const n=qe(1,1);return n.fillStyle="rgba(0,0,0,0)",n.fillRect(0,0,1,1),n.canvas}const bn=.5,Ys=10,qi=.25;class Cn{constructor(e,t,i,s,r,a,o){this.sourceProj_=e,this.targetProj_=t;let l={};const c=o?as(L=>nt(o,cn(L,this.targetProj_,this.sourceProj_))):os(this.targetProj_,this.sourceProj_);this.transformInv_=function(L){const m=L[0]+"/"+L[1];return l[m]||(l[m]=c(L)),l[m]},this.maxSourceExtent_=s,this.errorThresholdSquared_=r*r,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!s&&!!this.sourceProj_.getExtent()&&Q(s)>=Q(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?Q(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?Q(this.targetProj_.getExtent()):null;const d=Xe(i),u=ls(i),f=cs(i),y=ds(i),h=this.transformInv_(d),_=this.transformInv_(u),T=this.transformInv_(f),w=this.transformInv_(y),p=Ys+(a?Math.max(0,Math.ceil(Math.log2(it(i)/(a*a*256*256)))):0);if(this.addQuad_(d,u,f,y,h,_,T,w,p),this.wrapsXInSource_){let L=1/0;this.triangles_.forEach(function(m,g,P){L=Math.min(L,m.source[0][0],m.source[1][0],m.source[2][0])}),this.triangles_.forEach(m=>{if(Math.max(m.source[0][0],m.source[1][0],m.source[2][0])-L>this.sourceWorldWidth_/2){const g=[[m.source[0][0],m.source[0][1]],[m.source[1][0],m.source[1][1]],[m.source[2][0],m.source[2][1]]];g[0][0]-L>this.sourceWorldWidth_/2&&(g[0][0]-=this.sourceWorldWidth_),g[1][0]-L>this.sourceWorldWidth_/2&&(g[1][0]-=this.sourceWorldWidth_),g[2][0]-L>this.sourceWorldWidth_/2&&(g[2][0]-=this.sourceWorldWidth_);const P=Math.min(g[0][0],g[1][0],g[2][0]);Math.max(g[0][0],g[1][0],g[2][0])-P<this.sourceWorldWidth_/2&&(m.source=g)}})}l={}}addTriangle_(e,t,i,s,r,a){this.triangles_.push({source:[s,r,a],target:[e,t,i]})}addQuad_(e,t,i,s,r,a,o,l,c){const d=Di([r,a,o,l]),u=this.sourceWorldWidth_?Q(d)/this.sourceWorldWidth_:null,f=this.sourceWorldWidth_,y=this.sourceProj_.canWrapX()&&u>.5&&u<1;let h=!1;if(c>0){if(this.targetProj_.isGlobal()&&this.targetWorldWidth_){const T=Di([e,t,i,s]);h=Q(T)/this.targetWorldWidth_>qi||h}!y&&this.sourceProj_.isGlobal()&&u&&(h=u>qi||h)}if(!h&&this.maxSourceExtent_&&isFinite(d[0])&&isFinite(d[1])&&isFinite(d[2])&&isFinite(d[3])&&!hi(d,this.maxSourceExtent_))return;let _=0;if(!h&&(!isFinite(r[0])||!isFinite(r[1])||!isFinite(a[0])||!isFinite(a[1])||!isFinite(o[0])||!isFinite(o[1])||!isFinite(l[0])||!isFinite(l[1]))){if(c>0)h=!0;else if(_=(!isFinite(r[0])||!isFinite(r[1])?8:0)+(!isFinite(a[0])||!isFinite(a[1])?4:0)+(!isFinite(o[0])||!isFinite(o[1])?2:0)+(!isFinite(l[0])||!isFinite(l[1])?1:0),_!=1&&_!=2&&_!=4&&_!=8)return}if(c>0){if(!h){const T=[(e[0]+i[0])/2,(e[1]+i[1])/2],w=this.transformInv_(T);let p;y?p=(wt(r[0],f)+wt(o[0],f))/2-wt(w[0],f):p=(r[0]+o[0])/2-w[0];const L=(r[1]+o[1])/2-w[1];h=p*p+L*L>this.errorThresholdSquared_}if(h){if(Math.abs(e[0]-i[0])<=Math.abs(e[1]-i[1])){const T=[(t[0]+i[0])/2,(t[1]+i[1])/2],w=this.transformInv_(T),p=[(s[0]+e[0])/2,(s[1]+e[1])/2],L=this.transformInv_(p);this.addQuad_(e,t,T,p,r,a,w,L,c-1),this.addQuad_(p,T,i,s,L,w,o,l,c-1)}else{const T=[(e[0]+t[0])/2,(e[1]+t[1])/2],w=this.transformInv_(T),p=[(i[0]+s[0])/2,(i[1]+s[1])/2],L=this.transformInv_(p);this.addQuad_(e,T,p,s,r,w,L,l,c-1),this.addQuad_(T,t,i,p,w,a,o,L,c-1)}return}}if(y){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}_&11||this.addTriangle_(e,i,s,r,o,l),_&14||this.addTriangle_(e,i,t,r,o,a),_&&(_&13||this.addTriangle_(t,s,e,a,l,r),_&7||this.addTriangle_(t,s,i,a,l,o))}calculateSourceExtent(){const e=Ot();return this.triangles_.forEach(function(t,i,s){const r=t.source;qt(e,r[0]),qt(e,r[1]),qt(e,r[2])}),e}getTriangles(){return this.triangles_}}let Bt;const Ue=[];function Xi(n,e,t,i,s){n.beginPath(),n.moveTo(0,0),n.lineTo(e,t),n.lineTo(i,s),n.closePath(),n.save(),n.clip(),n.fillRect(0,0,Math.max(e,i)+1,Math.max(t,s)),n.restore()}function $t(n,e){return Math.abs(n[e*4]-210)>2||Math.abs(n[e*4+3]-.75*255)>2}function Hs(){if(Bt===void 0){const n=qe(6,6,Ue);n.globalCompositeOperation="lighter",n.fillStyle="rgba(210, 0, 0, 0.75)",Xi(n,4,5,4,0),Xi(n,4,5,0,5);const e=n.getImageData(0,0,3,3).data;Bt=$t(e,0)||$t(e,4)||$t(e,8),fi(n),Ue.push(n.canvas)}return Bt}function Ki(n,e,t,i){const s=cn(t,e,n);let r=st(e,i,t);const a=e.getMetersPerUnit();a!==void 0&&(r*=a);const o=n.getMetersPerUnit();o!==void 0&&(r/=o);const l=n.getExtent();if(!l||gi(l,s)){const c=st(n,r,s)/r;isFinite(c)&&c>0&&(r/=c)}return r}function Ln(n,e,t,i){const s=us(t);let r=Ki(n,e,s,i);return(!isFinite(r)||r<=0)&&on(t,function(a){return r=Ki(n,e,a,i),isFinite(r)&&r>0}),r}function Vs(n,e,t,i,s,r,a,o,l,c,d,u,f,y){const h=qe(Math.round(t*n),Math.round(t*e),Ue);if(u||(h.imageSmoothingEnabled=!1),l.length===0)return h.canvas;h.scale(t,t);function _(g){return Math.round(g*t)/t}h.globalCompositeOperation="lighter";const T=Ot();l.forEach(function(g,P,q){dn(T,g.extent)});let w;const p=t/i,L=(u?1:1+Math.pow(2,-24))/p;w=qe(Math.round(Q(T)*p),Math.round(be(T)*p),Ue),u||(w.imageSmoothingEnabled=!1),l.forEach(function(g,P,q){if(g.image.width>0&&g.image.height>0){if(g.clipExtent){w.save();const M=(g.clipExtent[0]-T[0])*p,z=-(g.clipExtent[3]-T[3])*p,X=Q(g.clipExtent)*p,D=be(g.clipExtent)*p;w.rect(u?M:Math.round(M),u?z:Math.round(z),u?X:Math.round(M+X)-Math.round(M),u?D:Math.round(z+D)-Math.round(z)),w.clip()}const O=(g.extent[0]-T[0])*p,N=-(g.extent[3]-T[3])*p,I=Q(g.extent)*p,G=be(g.extent)*p;w.drawImage(g.image,c,c,g.image.width-2*c,g.image.height-2*c,u?O:Math.round(O),u?N:Math.round(N),u?I:Math.round(O+I)-Math.round(O),u?G:Math.round(N+G)-Math.round(N)),g.clipExtent&&w.restore()}});const m=Xe(a);return o.getTriangles().forEach(function(g,P,q){const O=g.source,N=g.target;let I=O[0][0],G=O[0][1],M=O[1][0],z=O[1][1],X=O[2][0],D=O[2][1];const W=_((N[0][0]-m[0])/r),k=_(-(N[0][1]-m[1])/r),v=_((N[1][0]-m[0])/r),E=_(-(N[1][1]-m[1])/r),x=_((N[2][0]-m[0])/r),A=_(-(N[2][1]-m[1])/r),R=I,F=G;I=0,G=0,M-=R,z-=F,X-=R,D-=F;const K=[[M,z,0,0,v-W],[X,D,0,0,x-W],[0,0,M,z,E-k],[0,0,X,D,A-k]],B=hs(K);if(!B)return;if(h.save(),h.beginPath(),Hs()||!u){h.moveTo(v,E);const Z=4,de=W-v,ge=k-E;for(let le=0;le<Z;le++)h.lineTo(v+_((le+1)*de/Z),E+_(le*ge/(Z-1))),le!=Z-1&&h.lineTo(v+_((le+1)*de/Z),E+_((le+1)*ge/(Z-1)));h.lineTo(x,A)}else h.moveTo(v,E),h.lineTo(W,k),h.lineTo(x,A);h.clip(),h.transform(B[0],B[2],B[1],B[3],W,k),h.translate(T[0]-R,T[3]-F);let V;if(w)V=w.canvas,h.scale(L,-L);else{const Z=l[0],de=Z.extent;V=Z.image,h.scale(Q(de)/V.width,-be(de)/V.height)}h.drawImage(V,0,0),h.restore()}),w&&(fi(w),Ue.push(w.canvas)),d&&(h.save(),h.globalCompositeOperation="source-over",h.strokeStyle="black",h.lineWidth=1,o.getTriangles().forEach(function(g,P,q){const O=g.target,N=(O[0][0]-m[0])/r,I=-(O[0][1]-m[1])/r,G=(O[1][0]-m[0])/r,M=-(O[1][1]-m[1])/r,z=(O[2][0]-m[0])/r,X=-(O[2][1]-m[1])/r;h.beginPath(),h.moveTo(G,M),h.lineTo(N,I),h.lineTo(z,X),h.closePath(),h.stroke()}),h.restore()),h.canvas}class ti extends Ti{constructor(e,t,i,s,r,a,o,l,c,d,u,f){super(r,b.IDLE,f),this.renderEdges_=u!==void 0?u:!1,this.pixelRatio_=o,this.gutter_=l,this.canvas_=null,this.sourceTileGrid_=t,this.targetTileGrid_=s,this.wrappedTileCoord_=a||r,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0,this.clipExtent_=e.canWrapX()?e.getExtent():void 0;const y=s.getTileCoordExtent(this.wrappedTileCoord_),h=this.targetTileGrid_.getExtent();let _=this.sourceTileGrid_.getExtent();const T=h?ce(y,h):y;if(it(T)===0){this.state=b.EMPTY;return}const w=e.getExtent();w&&(_?_=ce(_,w):_=w);const p=s.getResolution(this.wrappedTileCoord_[0]),L=Ln(e,i,T,p);if(!isFinite(L)||L<=0){this.state=b.EMPTY;return}const m=d!==void 0?d:bn;if(this.triangulation_=new Cn(e,i,T,_,L*m,p),this.triangulation_.getTriangles().length===0){this.state=b.EMPTY;return}this.sourceZ_=t.getZForResolution(L);let g=this.triangulation_.calculateSourceExtent();if(_&&(e.canWrapX()?(g[1]=Ke(g[1],_[1],_[3]),g[3]=Ke(g[3],_[1],_[3])):g=ce(g,_)),!it(g))this.state=b.EMPTY;else{let P=0,q=0;e.canWrapX()&&(P=Q(w),q=Math.floor((g[0]-w[0])/P)),hn(g.slice(),e,!0).forEach(N=>{const I=t.getTileRangeForExtentAndZ(N,this.sourceZ_);for(let G=I.minX;G<=I.maxX;G++)for(let M=I.minY;M<=I.maxY;M++){const z=c(this.sourceZ_,G,M,o);if(z){const X=q*P;this.sourceTiles_.push({tile:z,offset:X})}}++q}),this.sourceTiles_.length===0&&(this.state=b.EMPTY)}}getImage(){return this.canvas_}reproject_(){const e=[];if(this.sourceTiles_.forEach(t=>{var s;const i=t.tile;if(i&&i.getState()==b.LOADED){const r=this.sourceTileGrid_.getTileCoordExtent(i.tileCoord);r[0]+=t.offset,r[2]+=t.offset;const a=(s=this.clipExtent_)==null?void 0:s.slice();a&&(a[0]+=t.offset,a[2]+=t.offset),e.push({extent:r,clipExtent:a,image:i.getImage()})}}),this.sourceTiles_.length=0,e.length===0)this.state=b.ERROR;else{const t=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(t),s=typeof i=="number"?i:i[0],r=typeof i=="number"?i:i[1],a=this.targetTileGrid_.getResolution(t),o=this.sourceTileGrid_.getResolution(this.sourceZ_),l=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=Vs(s,r,this.pixelRatio_,o,this.sourceTileGrid_.getExtent(),a,l,this.triangulation_,e,this.gutter_,this.renderEdges_,this.interpolate),this.state=b.LOADED}this.changed()}load(){if(this.state==b.IDLE){this.state=b.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const i=t.getState();if(i==b.IDLE||i==b.LOADING){e++;const s=H(t,$.CHANGE,r=>{const a=t.getState();(a==b.LOADED||a==b.ERROR||a==b.EMPTY)&&(ee(s),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(s)}}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t},i,s){t.getState()==b.IDLE&&t.load()})}}unlistenSources_(){this.sourcesListenerKeys_.forEach(ee),this.sourcesListenerKeys_=null}release(){this.canvas_&&(fi(this.canvas_.getContext("2d")),Ue.push(this.canvas_),this.canvas_=null),super.release()}}const Wt={TILELOADSTART:"tileloadstart",TILELOADEND:"tileloadend",TILELOADERROR:"tileloaderror"};class xi{constructor(e,t,i,s){this.minX=e,this.maxX=t,this.minY=i,this.maxY=s}contains(e){return this.containsXY(e[1],e[2])}containsTileRange(e){return this.minX<=e.minX&&e.maxX<=this.maxX&&this.minY<=e.minY&&e.maxY<=this.maxY}containsXY(e,t){return this.minX<=e&&e<=this.maxX&&this.minY<=t&&t<=this.maxY}equals(e){return this.minX==e.minX&&this.minY==e.minY&&this.maxX==e.maxX&&this.maxY==e.maxY}extend(e){e.minX<this.minX&&(this.minX=e.minX),e.maxX>this.maxX&&(this.maxX=e.maxX),e.minY<this.minY&&(this.minY=e.minY),e.maxY>this.maxY&&(this.maxY=e.maxY)}getHeight(){return this.maxY-this.minY+1}getSize(){return[this.getWidth(),this.getHeight()]}getWidth(){return this.maxX-this.minX+1}intersects(e){return this.minX<=e.maxX&&this.maxX>=e.minX&&this.minY<=e.maxY&&this.maxY>=e.minY}}function Pe(n,e,t,i,s){return s!==void 0?(s.minX=n,s.maxX=e,s.minY=t,s.maxY=i,s):new xi(n,e,t,i)}function Rt(n,e,t,i){return i!==void 0?(i[0]=n,i[1]=e,i[2]=t,i):[n,e,t]}function Zs(n,e,t){return n+"/"+e+"/"+t}function Qs(n){return Js(n[0],n[1],n[2])}function Js(n,e,t){return(e<<n)+t}function er(n,e){const t=n[0],i=n[1],s=n[2];if(e.getMinZoom()>t||t>e.getMaxZoom())return!1;const r=e.getFullTileRange(t);return r?r.containsXY(i,s):!0}const De=[0,0,0],ye=5;class Rn{constructor(e){this.minZoom=e.minZoom!==void 0?e.minZoom:0,this.resolutions_=e.resolutions,ie(fs(this.resolutions_,(s,r)=>r-s),"`resolutions` must be sorted in descending order");let t;if(!e.origins){for(let s=0,r=this.resolutions_.length-1;s<r;++s)if(!t)t=this.resolutions_[s]/this.resolutions_[s+1];else if(this.resolutions_[s]/this.resolutions_[s+1]!==t){t=void 0;break}}this.zoomFactor_=t,this.maxZoom=this.resolutions_.length-1,this.origin_=e.origin!==void 0?e.origin:null,this.origins_=null,e.origins!==void 0&&(this.origins_=e.origins,ie(this.origins_.length==this.resolutions_.length,"Number of `origins` and `resolutions` must be equal"));const i=e.extent;i!==void 0&&!this.origin_&&!this.origins_&&(this.origin_=Xe(i)),ie(!this.origin_&&this.origins_||this.origin_&&!this.origins_,"Either `origin` or `origins` must be configured, never both"),this.tileSizes_=null,e.tileSizes!==void 0&&(this.tileSizes_=e.tileSizes,ie(this.tileSizes_.length==this.resolutions_.length,"Number of `tileSizes` and `resolutions` must be equal")),this.tileSize_=e.tileSize!==void 0?e.tileSize:this.tileSizes_?null:un,ie(!this.tileSize_&&this.tileSizes_||this.tileSize_&&!this.tileSizes_,"Either `tileSize` or `tileSizes` must be configured, never both"),this.extent_=i!==void 0?i:null,this.fullTileRanges_=null,this.tmpSize_=[0,0],this.tmpExtent_=[0,0,0,0],e.sizes!==void 0?this.fullTileRanges_=e.sizes.map((s,r)=>{const a=new xi(Math.min(0,s[0]),Math.max(s[0]-1,-1),Math.min(0,s[1]),Math.max(s[1]-1,-1));if(i){const o=this.getTileRangeForExtentAndZ(i,r);a.minX=Math.max(o.minX,a.minX),a.maxX=Math.min(o.maxX,a.maxX),a.minY=Math.max(o.minY,a.minY),a.maxY=Math.min(o.maxY,a.maxY)}return a}):i&&this.calculateTileRanges_(i)}forEachTileCoord(e,t,i){const s=this.getTileRangeForExtentAndZ(e,t);for(let r=s.minX,a=s.maxX;r<=a;++r)for(let o=s.minY,l=s.maxY;o<=l;++o)i([t,r,o])}forEachTileCoordParentTileRange(e,t,i,s){let r,a,o,l=null,c=e[0]-1;for(this.zoomFactor_===2?(a=e[1],o=e[2]):l=this.getTileCoordExtent(e,s);c>=this.minZoom;){if(a!==void 0&&o!==void 0?(a=Math.floor(a/2),o=Math.floor(o/2),r=Pe(a,a,o,o,i)):r=this.getTileRangeForExtentAndZ(l,c,i),t(c,r))return!0;--c}return!1}getExtent(){return this.extent_}getMaxZoom(){return this.maxZoom}getMinZoom(){return this.minZoom}getOrigin(e){return this.origin_?this.origin_:this.origins_[e]}getResolution(e){return this.resolutions_[e]}getResolutions(){return this.resolutions_}getTileCoordChildTileRange(e,t,i){if(e[0]<this.maxZoom){if(this.zoomFactor_===2){const r=e[1]*2,a=e[2]*2;return Pe(r,r+1,a,a+1,t)}const s=this.getTileCoordExtent(e,i||this.tmpExtent_);return this.getTileRangeForExtentAndZ(s,e[0]+1,t)}return null}getTileRangeForTileCoordAndZ(e,t,i){if(t>this.maxZoom||t<this.minZoom)return null;const s=e[0],r=e[1],a=e[2];if(t===s)return Pe(r,a,r,a,i);if(this.zoomFactor_){const l=Math.pow(this.zoomFactor_,t-s),c=Math.floor(r*l),d=Math.floor(a*l);if(t<s)return Pe(c,c,d,d,i);const u=Math.floor(l*(r+1))-1,f=Math.floor(l*(a+1))-1;return Pe(c,u,d,f,i)}const o=this.getTileCoordExtent(e,this.tmpExtent_);return this.getTileRangeForExtentAndZ(o,t,i)}getTileRangeForExtentAndZ(e,t,i){this.getTileCoordForXYAndZ_(e[0],e[3],t,!1,De);const s=De[1],r=De[2];this.getTileCoordForXYAndZ_(e[2],e[1],t,!0,De);const a=De[1],o=De[2];return Pe(s,a,r,o,i)}getTileCoordCenter(e){const t=this.getOrigin(e[0]),i=this.getResolution(e[0]),s=Ce(this.getTileSize(e[0]),this.tmpSize_);return[t[0]+(e[1]+.5)*s[0]*i,t[1]-(e[2]+.5)*s[1]*i]}getTileCoordExtent(e,t){const i=this.getOrigin(e[0]),s=this.getResolution(e[0]),r=Ce(this.getTileSize(e[0]),this.tmpSize_),a=i[0]+e[1]*r[0]*s,o=i[1]-(e[2]+1)*r[1]*s,l=a+r[0]*s,c=o+r[1]*s;return di(a,o,l,c,t)}getTileCoordForCoordAndResolution(e,t,i){return this.getTileCoordForXYAndResolution_(e[0],e[1],t,!1,i)}getTileCoordForXYAndResolution_(e,t,i,s,r){const a=this.getZForResolution(i),o=i/this.getResolution(a),l=this.getOrigin(a),c=Ce(this.getTileSize(a),this.tmpSize_);let d=o*(e-l[0])/i/c[0],u=o*(l[1]-t)/i/c[1];return s?(d=mt(d,ye)-1,u=mt(u,ye)-1):(d=yt(d,ye),u=yt(u,ye)),Rt(a,d,u,r)}getTileCoordForXYAndZ_(e,t,i,s,r){const a=this.getOrigin(i),o=this.getResolution(i),l=Ce(this.getTileSize(i),this.tmpSize_);let c=(e-a[0])/o/l[0],d=(a[1]-t)/o/l[1];return s?(c=mt(c,ye)-1,d=mt(d,ye)-1):(c=yt(c,ye),d=yt(d,ye)),Rt(i,c,d,r)}getTileCoordForCoordAndZ(e,t,i){return this.getTileCoordForXYAndZ_(e[0],e[1],t,!1,i)}getTileCoordResolution(e){return this.resolutions_[e[0]]}getTileSize(e){return this.tileSize_?this.tileSize_:this.tileSizes_[e]}getFullTileRange(e){return this.fullTileRanges_?this.fullTileRanges_[e]:this.extent_?this.getTileRangeForExtentAndZ(this.extent_,e):null}getZForResolution(e,t){const i=gs(this.resolutions_,e,t||0);return Ke(i,this.minZoom,this.maxZoom)}tileCoordIntersectsViewport(e,t){return _s(t,0,t.length,2,this.getTileCoordExtent(e))}calculateTileRanges_(e){const t=this.resolutions_.length,i=new Array(t);for(let s=this.minZoom;s<t;++s)i[s]=this.getTileRangeForExtentAndZ(e,s);this.fullTileRanges_=i}}function Sn(n){let e=n.getDefaultTileGrid();return e||(e=sr(n),n.setDefaultTileGrid(e)),e}function tr(n,e,t){const i=e[0],s=n.getTileCoordCenter(e),r=wi(t);if(!gi(r,s)){const a=Q(r),o=Math.ceil((r[0]-s[0])/a);return s[0]+=a*o,n.getTileCoordForCoordAndZ(s,i)}return e}function ir(n,e,t,i){i=i!==void 0?i:"top-left";const s=An(n,e,t);return new Rn({extent:n,origin:ms(n,i),resolutions:s,tileSize:t})}function nr(n){const e=n,t=e.extent||_i("EPSG:3857").getExtent(),i={extent:t,minZoom:e.minZoom,tileSize:e.tileSize,resolutions:An(t,e.maxZoom,e.tileSize,e.maxResolution)};return new Rn(i)}function An(n,e,t,i){e=e!==void 0?e:ys,t=Ce(t!==void 0?t:un);const s=be(n),r=Q(n);i=i>0?i:Math.max(r/t[0],s/t[1]);const a=e+1,o=new Array(a);for(let l=0;l<a;++l)o[l]=i/Math.pow(2,l);return o}function sr(n,e,t,i){const s=wi(n);return ir(s,e,t,i)}function wi(n){n=_i(n);let e=n.getExtent();if(!e){const t=180*fn.degrees/n.getMetersPerUnit();e=di(-t,-t,t,t)}return e}class rr extends ps{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:e.projection,state:e.state,wrapX:e.wrapX,interpolate:e.interpolate}),this.on,this.once,this.un,this.tilePixelRatio_=e.tilePixelRatio!==void 0?e.tilePixelRatio:1,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:null;const t=[256,256];this.tileGrid&&Ce(this.tileGrid.getTileSize(this.tileGrid.getMinZoom()),t),this.tmpSize=[0,0],this.key_=e.key||J(this),this.tileOptions={transition:e.transition,interpolate:e.interpolate},this.zDirection=e.zDirection?e.zDirection:0}getGutterForProjection(e){return 0}getKey(){return this.key_}setKey(e){this.key_!==e&&(this.key_=e,this.changed())}getResolutions(e){const t=e?this.getTileGridForProjection(e):this.tileGrid;return t?t.getResolutions():null}getTile(e,t,i,s,r){return Ct()}getTileGrid(){return this.tileGrid}getTileGridForProjection(e){return this.tileGrid?this.tileGrid:Sn(e)}getTilePixelRatio(e){return this.tilePixelRatio_}getTilePixelSize(e,t,i){const s=this.getTileGridForProjection(i),r=this.getTilePixelRatio(t),a=Ce(s.getTileSize(e),this.tmpSize);return r==1?a:Es(a,r,this.tmpSize)}getTileCoordForTileUrlFunction(e,t){const i=t!==void 0?t:this.getProjection(),s=t!==void 0?this.getTileGridForProjection(i):this.tileGrid||this.getTileGridForProjection(i);return this.getWrapX()&&i.isGlobal()&&(e=tr(s,e,i)),er(e,s)?e:null}clear(){}refresh(){this.clear(),super.refresh()}}class ar extends rt{constructor(e,t){super(e),this.tile=t}}const or=/\{z\}/g,lr=/\{x\}/g,cr=/\{y\}/g,dr=/\{-y\}/g;function hr(n,e,t,i,s){return n.replace(or,e.toString()).replace(lr,t.toString()).replace(cr,i.toString()).replace(dr,function(){if(s===void 0)throw new Error("If the URL template has a {-y} placeholder, the grid extent must be known");return(s-i).toString()})}function ur(n){const e=[];let t=/\{([a-z])-([a-z])\}/.exec(n);if(t){const i=t[1].charCodeAt(0),s=t[2].charCodeAt(0);let r;for(r=i;r<=s;++r)e.push(n.replace(t[0],String.fromCharCode(r)));return e}if(t=/\{(\d+)-(\d+)\}/.exec(n),t){const i=parseInt(t[2],10);for(let s=parseInt(t[1],10);s<=i;s++)e.push(n.replace(t[0],s.toString()));return e}return e.push(n),e}function fr(n,e){return function(t,i,s){if(!t)return;let r;const a=t[0];if(e){const o=e.getFullTileRange(a);o&&(r=o.getHeight()-1)}return hr(n,a,t[1],t[2],r)}}function gr(n,e){const t=n.length,i=new Array(t);for(let s=0;s<t;++s)i[s]=fr(n[s],e);return _r(i)}function _r(n){return n.length===1?n[0]:function(e,t,i){if(!e)return;const s=Qs(e),r=wt(s,n.length);return n[r](e,t,i)}}class bi extends rr{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,projection:e.projection,state:e.state,tileGrid:e.tileGrid,tilePixelRatio:e.tilePixelRatio,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection}),this.generateTileUrlFunction_=this.tileUrlFunction===bi.prototype.tileUrlFunction,this.tileLoadFunction=e.tileLoadFunction,e.tileUrlFunction&&(this.tileUrlFunction=e.tileUrlFunction),this.urls=null,e.urls?this.setUrls(e.urls):e.url&&this.setUrl(e.url),this.tileLoadingKeys_={}}getTileLoadFunction(){return this.tileLoadFunction}getTileUrlFunction(){return Object.getPrototypeOf(this).tileUrlFunction===this.tileUrlFunction?this.tileUrlFunction.bind(this):this.tileUrlFunction}getUrls(){return this.urls}handleTileChange(e){const t=e.target,i=J(t),s=t.getState();let r;s==b.LOADING?(this.tileLoadingKeys_[i]=!0,r=Wt.TILELOADSTART):i in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[i],r=s==b.ERROR?Wt.TILELOADERROR:s==b.LOADED?Wt.TILELOADEND:void 0),r!=null&&this.dispatchEvent(new ar(r,t))}setTileLoadFunction(e){this.tileLoadFunction=e,this.changed()}setTileUrlFunction(e,t){this.tileUrlFunction=e,typeof t<"u"?this.setKey(t):this.changed()}setUrl(e){const t=ur(e);this.urls=t,this.setUrls(t)}setUrls(e){this.urls=e;const t=e.join(`
`);this.generateTileUrlFunction_?this.setTileUrlFunction(gr(e,this.tileGrid),t):this.setKey(t)}tileUrlFunction(e,t,i){}}class mr extends bi{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,projection:e.projection,state:e.state,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction?e.tileLoadFunction:yr,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection}),this.crossOrigin=e.crossOrigin!==void 0?e.crossOrigin:null,this.tileClass=e.tileClass!==void 0?e.tileClass:wn,this.tileGridForProjection={},this.reprojectionErrorThreshold_=e.reprojectionErrorThreshold,this.renderReprojectionEdges_=!1}getGutterForProjection(e){return this.getProjection()&&e&&!Xt(this.getProjection(),e)?0:this.getGutter()}getGutter(){return 0}getKey(){let e=super.getKey();return this.getInterpolate()||(e+=":disable-interpolation"),e}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||Xt(t,e)))return this.tileGrid;const i=J(e);return i in this.tileGridForProjection||(this.tileGridForProjection[i]=Sn(e)),this.tileGridForProjection[i]}createTile_(e,t,i,s,r,a){const o=[e,t,i],l=this.getTileCoordForTileUrlFunction(o,r),c=l?this.tileUrlFunction(l,s,r):void 0,d=new this.tileClass(o,c!==void 0?b.IDLE:b.EMPTY,c!==void 0?c:"",this.crossOrigin,this.tileLoadFunction,this.tileOptions);return d.key=a,d.addEventListener($.CHANGE,this.handleTileChange.bind(this)),d}getTile(e,t,i,s,r){const a=this.getProjection();if(!a||!r||Xt(a,r))return this.getTileInternal(e,t,i,s,a||r);const o=[e,t,i],l=this.getKey(),c=this.getTileGridForProjection(a),d=this.getTileGridForProjection(r),u=this.getTileCoordForTileUrlFunction(o,r),f=new ti(a,c,r,d,o,u,this.getTilePixelRatio(s),this.getGutter(),(y,h,_,T)=>this.getTileInternal(y,h,_,T,a),this.reprojectionErrorThreshold_,this.renderReprojectionEdges_,this.tileOptions);return f.key=l,f}getTileInternal(e,t,i,s,r){const a=this.getKey();return this.createTile_(e,t,i,s,r,a)}setRenderReprojectionEdges(e){this.renderReprojectionEdges_!=e&&(this.renderReprojectionEdges_=e,this.changed())}setTileGridForProjection(e,t){const i=_i(e);if(i){const s=J(i);s in this.tileGridForProjection||(this.tileGridForProjection[s]=t)}}}function yr(n,e){n.getImage().src=e}class In extends mr{constructor(e){e=e||{};const t=e.projection!==void 0?e.projection:"EPSG:3857",i=e.tileGrid!==void 0?e.tileGrid:nr({extent:wi(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize});super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:t,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:i,tileLoadFunction:e.tileLoadFunction,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0}getGutter(){return this.gutter_}}function St(n){return n instanceof Image||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageBitmap?n:null}function pr(n){return n instanceof Uint8Array||n instanceof Uint8ClampedArray||n instanceof Float32Array||n instanceof DataView?n:null}const Er=new Error("disposed");let Me=null;function vr(n){Me||(Me=qe(n.width,n.height,void 0,{willReadFrequently:!0}));const e=Me.canvas,t=n.width;e.width!==t&&(e.width=t);const i=n.height;return e.height!==i&&(e.height=i),Me.clearRect(0,0,t,i),Me.drawImage(n,0,0),Me.getImageData(0,0,t,i).data}const Tr=[256,256];class ii extends Ti{constructor(e){const t=b.IDLE;super(e.tileCoord,t,{transition:e.transition,interpolate:e.interpolate}),this.loader_=e.loader,this.data_=null,this.error_=null,this.size_=e.size||null,this.controller_=e.controller||null}getSize(){if(this.size_)return this.size_;const e=St(this.data_);return e?[e.width,e.height]:Tr}getData(){return this.data_}getError(){return this.error_}load(){if(this.state!==b.IDLE&&this.state!==b.ERROR)return;this.state=b.LOADING,this.changed();const e=this;this.loader_().then(function(t){e.data_=t,e.state=b.LOADED,e.changed()}).catch(function(t){e.error_=t,e.state=b.ERROR,e.changed()})}disposeInternal(){this.controller_&&(this.controller_.abort(Er),this.controller_=null),super.disposeInternal()}}function kt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ni(n,e,t,i,s,r,a){a=a??kt();const o=1/(n-e),l=1/(t-i),c=1/(s-r);return a[0]=-2*o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*c,a[11]=0,a[12]=(n+e)*o,a[13]=(i+t)*l,a[14]=(r+s)*c,a[15]=1,a}function Bi(n,e,t,i,s){return s=s??kt(),s[0]=n[0]*e,s[1]=n[1]*e,s[2]=n[2]*e,s[3]=n[3]*e,s[4]=n[4]*t,s[5]=n[5]*t,s[6]=n[6]*t,s[7]=n[7]*t,s[8]=n[8]*i,s[9]=n[9]*i,s[10]=n[10]*i,s[11]=n[11]*i,s[12]=n[12],s[13]=n[13],s[14]=n[14],s[15]=n[15],s}function xr(n,e,t,i,s){s=s??kt();let r,a,o,l,c,d,u,f,y,h,_,T;return n===s?(s[12]=n[0]*e+n[4]*t+n[8]*i+n[12],s[13]=n[1]*e+n[5]*t+n[9]*i+n[13],s[14]=n[2]*e+n[6]*t+n[10]*i+n[14],s[15]=n[3]*e+n[7]*t+n[11]*i+n[15]):(r=n[0],a=n[1],o=n[2],l=n[3],c=n[4],d=n[5],u=n[6],f=n[7],y=n[8],h=n[9],_=n[10],T=n[11],s[0]=r,s[1]=a,s[2]=o,s[3]=l,s[4]=c,s[5]=d,s[6]=u,s[7]=f,s[8]=y,s[9]=h,s[10]=_,s[11]=T,s[12]=r*e+c*t+y*i+n[12],s[13]=a*e+d*t+h*i+n[13],s[14]=o*e+u*t+_*i+n[14],s[15]=l*e+f*t+T*i+n[15]),s}function wr(n,e,t,i){return i=i??kt(),i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=n,i[13]=e,i[14]=t,i[15]=1,i}const br=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,Cr=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class Lr{constructor(e){this.gl_=e,this.program_=si(e,Cr,br),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,i,s,r,a,o,l,c,d,u,f,y){const h=this.gl_;l===void 0&&(l=s),c===void 0&&(c=r),a===void 0&&(a=t),o===void 0&&(o=i),d===void 0&&(d=a),u===void 0&&(u=o),f===void 0&&(f=h.canvas.width),y===void 0&&(y=h.canvas.height),h.bindTexture(h.TEXTURE_2D,e),h.useProgram(this.program_),h.bindBuffer(h.ARRAY_BUFFER,this.positionBuffer),h.enableVertexAttribArray(this.positionLocation),h.vertexAttribPointer(this.positionLocation,2,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this.texcoordBuffer),h.enableVertexAttribArray(this.texcoordLocation),h.vertexAttribPointer(this.texcoordLocation,2,h.FLOAT,!1,0,0);let _=ni(0,f,0,y,-1,1);_=xr(_,l,c,0),_=Bi(_,d,u,1),h.uniformMatrix4fv(this.matrixLocation,!1,_);let T=wr(s/t,r/i,0);T=Bi(T,a/t,o/i,1),h.uniformMatrix4fv(this.textureMatrixLocation,!1,T),h.uniform1i(this.textureLocation,0),h.drawArrays(h.TRIANGLES,0,this.positions.length/2)}}function $i(n,e,t){const i=n.createShader(e);if(i===null)throw new Error("Shader compilation failed");if(n.shaderSource(i,t),n.compileShader(i),!n.getShaderParameter(i,n.COMPILE_STATUS)){const s=n.getShaderInfoLog(i);throw s===null?new Error("Shader info log creation failed"):new Error(s)}return i}function si(n,e,t){const i=n.createProgram(),s=$i(n,n.VERTEX_SHADER,t),r=$i(n,n.FRAGMENT_SHADER,e);if(i===null)throw new Error("Program creation failed");if(n.attachShader(i,s),n.attachShader(i,r),n.linkProgram(i),!n.getProgramParameter(i,n.LINK_STATUS))throw n.getProgramInfoLog(i)===null?new Error("Program info log creation failed"):new Error;return i}const Rr=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,Sr=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,Ar=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,Ir=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function Pr(n,e,t,i){let s;return t.length?s=t.shift():vs?s=new OffscreenCanvas(n||300,e||300):s=document.createElement("canvas"),n&&(s.width=n),e&&(s.height=e),s.getContext("webgl",i)}function Dr(n){const e=n.canvas;e.width=1,e.height=1,n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT)}const Wi=[];function Mr(n,e,t,i,s,r,a,o,l,c,d,u,f,y){const h=Math.round(i*e),_=Math.round(i*t);n.canvas.width=h,n.canvas.height=_;let T,w;if(w=n.createTexture(),n.bindTexture(n.TEXTURE_2D,w),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),f?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,h,_,0,n.RGBA,d,null),T=n.createFramebuffer(),n.bindFramebuffer(n.FRAMEBUFFER,T),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,w,0),T===null)throw new Error("Could not create framebuffer");if(w===null)throw new Error("Could not create texture");if(l.length===0)return{width:h,height:_,framebuffer:T,texture:w};const p=Ot();l.forEach(function(I,G,M){dn(p,I.extent)});let L,m,g;const P=1/s;{if(L=n.createTexture(),w===null)throw new Error("Could not create texture");m=Math.round(Q(p)*P),g=Math.round(be(p)*P);const I=n.getParameter(n.MAX_TEXTURE_SIZE),G=Math.max(m,g),M=G>I?I/G:1,z=Math.round(m*M),X=Math.round(g*M);n.bindTexture(n.TEXTURE_2D,L),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),f?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,z,X,0,n.RGBA,d,null);const D=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,D),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,L,0);const W=new Lr(n);l.forEach(function(k,v,E){const x=(k.extent[0]-p[0])*P*M,A=-(k.extent[3]-p[3])*P*M,R=Q(k.extent)*P*M,F=be(k.extent)*P*M;if(n.bindFramebuffer(n.FRAMEBUFFER,D),n.viewport(0,0,z,X),k.clipExtent){const K=(k.clipExtent[0]-p[0])*P*M,B=-(k.clipExtent[3]-p[3])*P*M,V=Q(k.clipExtent)*P*M,Z=be(k.clipExtent)*P*M;n.enable(n.SCISSOR_TEST),n.scissor(f?K:Math.round(K),f?B:Math.round(B),f?V:Math.round(K+V)-Math.round(K),f?Z:Math.round(B+Z)-Math.round(B))}W.drawImage(k.texture,k.width,k.height,c,c,k.width-2*c,k.height-2*c,f?x:Math.round(x),f?A:Math.round(A),f?R:Math.round(x+R)-Math.round(x),f?F:Math.round(A+F)-Math.round(A),z,X),n.disable(n.SCISSOR_TEST)}),n.deleteFramebuffer(D)}const q=Xe(a),O=Xe(p),N=I=>{const G=(I[0][0]-q[0])/r*i,M=-(I[0][1]-q[1])/r*i,z=(I[1][0]-q[0])/r*i,X=-(I[1][1]-q[1])/r*i,D=(I[2][0]-q[0])/r*i,W=-(I[2][1]-q[1])/r*i;return{u1:z,v1:X,u0:G,v0:M,u2:D,v2:W}};n.bindFramebuffer(n.FRAMEBUFFER,T),n.viewport(0,0,h,_);{const I=[],G=[],M=si(n,Ir,Ar);n.useProgram(M);const z=n.getUniformLocation(M,"u_texture");n.bindTexture(n.TEXTURE_2D,L),n.uniform1i(z,0),o.getTriangles().forEach(function(x,A,R){const F=x.source,K=x.target,{u1:B,v1:V,u0:Z,v0:de,u2:ge,v2:le}=N(K),Le=(F[0][0]-O[0])/s/m,dt=-(F[0][1]-O[1])/s/g,ht=(F[1][0]-O[0])/s/m,Ut=-(F[1][1]-O[1])/s/g,ut=(F[2][0]-O[0])/s/m,zt=-(F[2][1]-O[1])/s/g;I.push(B,V,Z,de,ge,le),G.push(ht,Ut,Le,dt,ut,zt)});const X=ni(0,h,_,0,-1,1),D=n.getUniformLocation(M,"u_matrix");n.uniformMatrix4fv(D,!1,X);const W=n.getAttribLocation(M,"a_position"),k=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,k),n.bufferData(n.ARRAY_BUFFER,new Float32Array(I),n.STATIC_DRAW),n.vertexAttribPointer(W,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(W);const v=n.getAttribLocation(M,"a_texcoord"),E=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,E),n.bufferData(n.ARRAY_BUFFER,new Float32Array(G),n.STATIC_DRAW),n.vertexAttribPointer(v,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(v),n.drawArrays(n.TRIANGLES,0,I.length/2)}if(u){const I=si(n,Sr,Rr);n.useProgram(I);const G=ni(0,h,_,0,-1,1),M=n.getUniformLocation(I,"u_matrix");n.uniformMatrix4fv(M,!1,G);const z=Array.isArray(u)?u:[0,0,0,255],X=n.getUniformLocation(I,"u_val");n.uniform4fv(X,z);const D=n.getAttribLocation(I,"a_position"),W=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,W),n.vertexAttribPointer(D,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(D);const k=o.getTriangles().reduce(function(v,E){const x=E.target,{u1:A,v1:R,u0:F,v0:K,u2:B,v2:V}=N(x);return v.concat([A,R,F,K,F,K,B,V,B,V,A,R])},[]);n.bufferData(n.ARRAY_BUFFER,new Float32Array(k),n.STATIC_DRAW),n.drawArrays(n.LINES,0,k.length/2)}return{width:h,height:_,framebuffer:T,texture:w}}class Fr extends ii{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,i=t.getExtent(),s=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?s?ce(i,s):i:s;const r=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),a=this.targetTileGrid_.getExtent();let o=this.sourceTileGrid_.getExtent();const l=a?ce(r,a):r;if(it(l)===0){this.state=b.EMPTY;return}i&&(o?o=ce(o,i):o=i);const c=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),d=e.targetProj,u=Ln(t,d,l,c);if(!isFinite(u)||u<=0){this.state=b.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:bn;if(this.triangulation_=new Cn(t,d,l,o,u*f,c,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=b.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(u);let y=this.triangulation_.calculateSourceExtent();if(o&&(t.canWrapX()?(y[1]=Ke(y[1],o[1],o[3]),y[3]=Ke(y[3],o[1],o[3])):y=ce(y,o)),!it(y))this.state=b.EMPTY;else{let h=0,_=0;t.canWrapX()&&(h=Q(i),_=Math.floor((y[0]-i[0])/h)),hn(y.slice(),t,!0).forEach(w=>{const p=this.sourceTileGrid_.getTileRangeForExtentAndZ(w,this.sourceZ_),L=e.getTileFunction;for(let m=p.minX;m<=p.maxX;m++)for(let g=p.minY;g<=p.maxY;g++){const P=L(this.sourceZ_,m,g,this.pixelRatio_);if(P){const q=_*h;this.sourceTiles_.push({tile:P,offset:q})}}++_}),this.sourceTiles_.length===0&&(this.state=b.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(m=>{var A;const g=m.tile;if(!g||g.getState()!==b.LOADED)return;const P=g.getSize(),q=this.gutter_;let O;const N=pr(g.getData());N?O=N:(t=!0,O=vr(St(g.getData())));const I=[P[0]+2*q,P[1]+2*q],G=O instanceof Float32Array,M=I[0]*I[1],z=G?Float32Array:Uint8ClampedArray,X=new z(O.buffer),D=z.BYTES_PER_ELEMENT,W=D*X.length/M,k=X.byteLength/I[1],v=Math.floor(k/D/I[0]),E=this.sourceTileGrid_.getTileCoordExtent(g.tileCoord);E[0]+=m.offset,E[2]+=m.offset;const x=(A=this.clipExtent_)==null?void 0:A.slice();x&&(x[0]+=m.offset,x[2]+=m.offset),e.push({extent:E,clipExtent:x,data:X,dataType:z,bytesPerPixel:W,pixelSize:I,bandCount:v})}),this.sourceTiles_.length=0,e.length===0){this.state=b.ERROR,this.changed();return}const i=this.wrappedTileCoord_[0],s=this.targetTileGrid_.getTileSize(i),r=typeof s=="number"?s:s[0],a=typeof s=="number"?s:s[1],o=r*this.pixelRatio_,l=a*this.pixelRatio_,c=this.targetTileGrid_.getResolution(i),d=this.sourceTileGrid_.getResolution(this.sourceZ_),u=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,y=new e[0].dataType(f*o*l),h=Pr(o,l,Wi,{premultipliedAlpha:!1,antialias:!1});let _;const T=h.RGBA;let w;e[0].dataType==Float32Array?(w=h.FLOAT,h.getExtension("WEBGL_color_buffer_float"),h.getExtension("OES_texture_float"),h.getExtension("EXT_float_blend"),_=h.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(w=h.UNSIGNED_BYTE,_=this.interpolate);const p=4,L=Math.ceil(f/p);for(let m=L-1;m>=0;--m){const g=[];for(let z=0,X=e.length;z<X;++z){const D=e[z],W=D.pixelSize,k=W[0],v=W[1],E=new D.dataType(p*k*v),x=D.data;let A=m*p;for(let F=0,K=E.length;F<K;F+=p)E[F]=x[A],E[F+1]=x[A+1],E[F+2]=x[A+2],E[F+3]=x[A+3],A+=f;const R=h.createTexture();h.bindTexture(h.TEXTURE_2D,R),_?(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR)):(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.NEAREST)),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texImage2D(h.TEXTURE_2D,0,T,k,v,0,T,w,E),g.push({extent:D.extent,clipExtent:D.clipExtent,texture:R,width:k,height:v})}const{framebuffer:P,width:q,height:O}=Mr(h,r,a,this.pixelRatio_,d,c,u,this.triangulation_,g,this.gutter_,w,this.renderEdges_,_),N=q,I=O*p,G=new e[0].dataType(N*I);h.bindFramebuffer(h.FRAMEBUFFER,P),h.readPixels(0,0,q,O,h.RGBA,w,G);let M=m*p;for(let z=0,X=G.length;z<X;z+=p){const D=(N-1-(z/I|0))*I+z%I;y[M]=G[D],y[M+1]=G[D+1],y[M+2]=G[D+2],y[M+3]=G[D+3],M+=f}}if(Dr(h),Wi.push(h.canvas),t){const m=qe(r,a),g=new ImageData(y,r);m.putImageData(g,0,0),this.reprojData_=m.canvas}else this.reprojData_=y;this.reprojSize_=[Math.round(o),Math.round(l)],this.state=b.LOADED,this.changed()}load(){if(this.state!==b.IDLE&&this.state!==b.ERROR)return;this.state=b.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const i=t.getState();if(i!==b.IDLE&&i!==b.LOADING)return;e++;const s=H(t,$.CHANGE,()=>{const r=t.getState();(r==b.LOADED||r==b.ERROR||r==b.EMPTY)&&(ee(s),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(s)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==b.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(ee),this.sourcesListenerKeys_=null}}const Or='&#169; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors.';class kr extends In{constructor(e){e=e||{};let t;e.attributions!==void 0?t=e.attributions:t=[Or];const i=e.crossOrigin!==void 0?e.crossOrigin:"anonymous",s=e.url!==void 0?e.url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png";super({attributions:t,attributionsCollapsible:!1,cacheSize:e.cacheSize,crossOrigin:i,interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:19,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:s,wrapX:e.wrapX,zDirection:e.zDirection})}}const Tt={PRELOAD:"preload",USE_INTERIM_TILES_ON_ERROR:"useInterimTilesOnError"};class Nr extends mi{constructor(e){e=e||{};const t=Object.assign({},e),i=e.cacheSize;delete e.cacheSize,delete t.preload,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un,this.cacheSize_=i,this.setPreload(e.preload!==void 0?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0)}getCacheSize(){return this.cacheSize_}getPreload(){return this.get(Tt.PRELOAD)}setPreload(e){this.set(Tt.PRELOAD,e)}getUseInterimTilesOnError(){return this.get(Tt.USE_INTERIM_TILES_ON_ERROR)}setUseInterimTilesOnError(e){this.set(Tt.USE_INTERIM_TILES_ON_ERROR,e)}getData(e){return super.getData(e)}}function jt(n,e,t,i){return`${n},${Zs(e,t,i)}`}function Yt(n,e,t){if(!(t in n))return n[t]=new Set([e]),!0;const i=n[t],s=i.has(e);return s||i.add(e),!s}function Ur(n,e,t){const i=n[t];return i?i.delete(e):!1}function ji(n,e){const t=n.layerStatesArray[n.layerIndex];t.extent&&(e=ce(e,Jt(t.extent,n.viewState.projection)));const i=t.layer.getRenderSource();if(!i.getWrapX()){const s=i.getTileGridForProjection(n.viewState.projection).getExtent();s&&(e=ce(e,s))}return e}class zr extends Ts{constructor(e,t){super(e),t=t||{},this.extentChanged=!0,this.renderComplete=!1,this.renderedExtent_=null,this.renderedPixelRatio,this.renderedProjection=null,this.renderedRevision,this.renderedTiles=[],this.renderedSourceKey_,this.renderedSourceRevision_,this.tempExtent=Ot(),this.tempTileRange_=new xi(0,0,0,0),this.tempTileCoord_=Rt(0,0,0);const i=t.cacheSize!==void 0?t.cacheSize:512;this.tileCache_=new Ws(i),this.maxStaleKeys=i*.5}getTileCache(){return this.tileCache_}getOrCreateTile(e,t,i,s){const r=this.tileCache_,o=this.getLayer().getSource(),l=jt(o.getKey(),e,t,i);let c;if(r.containsKey(l))c=r.get(l);else{if(c=o.getTile(e,t,i,s.pixelRatio,s.viewState.projection),!c)return null;r.set(l,c)}return c}getTile(e,t,i,s){const r=this.getOrCreateTile(e,t,i,s);return r||null}getData(e){const t=this.frameState;if(!t)return null;const i=this.getLayer(),s=nt(t.pixelToCoordinateTransform,e.slice()),r=i.getExtent();if(r&&!gi(r,s))return null;const a=t.viewState,o=i.getRenderSource(),l=o.getTileGridForProjection(a.projection),c=o.getTilePixelRatio(t.pixelRatio);for(let d=l.getZForResolution(a.resolution);d>=l.getMinZoom();--d){const u=l.getTileCoordForCoordAndZ(s,d),f=this.getTile(d,u[1],u[2],t);if(!f||f.getState()!==b.LOADED)continue;const y=l.getOrigin(d),h=Ce(l.getTileSize(d)),_=l.getResolution(d);let T;if(f instanceof wn||f instanceof ti)T=f.getImage();else if(f instanceof ii){if(T=St(f.getData()),!T)continue}else continue;const w=Math.floor(c*((s[0]-y[0])/_-u[1]*h[0])),p=Math.floor(c*((y[1]-s[1])/_-u[2]*h[1])),L=Math.round(c*o.getGutterForProjection(a.projection));return this.getImageData(T,w+L,p+L)}return null}prepareFrame(e){this.renderedProjection?e.viewState.projection!==this.renderedProjection&&(this.tileCache_.clear(),this.renderedProjection=e.viewState.projection):this.renderedProjection=e.viewState.projection;const t=this.getLayer().getSource();if(!t)return!1;const i=t.getRevision();return this.renderedRevision_?this.renderedRevision_!==i&&(this.renderedRevision_=i,this.renderedSourceKey_===t.getKey()&&this.tileCache_.clear()):this.renderedRevision_=i,!0}enqueueTiles(e,t,i,s,r){const a=e.viewState,o=this.getLayer(),l=o.getRenderSource(),c=l.getTileGridForProjection(a.projection),d=J(l);d in e.wantedTiles||(e.wantedTiles[d]={});const u=e.wantedTiles[d],f=o.getMapInternal(),y=Math.max(i-r,c.getMinZoom(),c.getZForResolution(Math.min(o.getMaxResolution(),f?f.getView().getResolutionForZoom(Math.max(o.getMinZoom(),0)):c.getResolution(0)),l.zDirection));for(let h=i;h>=y;--h){const _=c.getTileRangeForExtentAndZ(t,h,this.tempTileRange_),T=c.getResolution(h);for(let w=_.minX;w<=_.maxX;++w)for(let p=_.minY;p<=_.maxY;++p){const L=this.getTile(h,w,p,e);if(!L||!Yt(s,L,h))continue;const g=L.getKey();if(u[g]=!0,L.getState()===b.IDLE&&!e.tileQueue.isKeyQueued(g)){const P=Rt(h,w,p,this.tempTileCoord_);e.tileQueue.enqueue([L,d,c.getTileCoordCenter(P),T])}}}}findStaleTile_(e,t){const i=this.tileCache_,s=e[0],r=e[1],a=e[2],o=this.getStaleKeys();for(let l=0;l<o.length;++l){const c=jt(o[l],s,r,a);if(i.containsKey(c)){const d=i.get(c);if(d.getState()===b.LOADED)return d.endTransition(J(this)),Yt(t,d,s),!0}}return!1}findAltTiles_(e,t,i,s){const r=e.getTileRangeForTileCoordAndZ(t,i,this.tempTileRange_);if(!r)return!1;let a=!0;const o=this.tileCache_,c=this.getLayer().getRenderSource().getKey();for(let d=r.minX;d<=r.maxX;++d)for(let u=r.minY;u<=r.maxY;++u){const f=jt(c,i,d,u);let y=!1;if(o.containsKey(f)){const h=o.get(f);h.getState()===b.LOADED&&(Yt(s,h,i),y=!0)}y||(a=!1)}return a}renderFrame(e,t){let i=!0;this.renderComplete=!0;const s=e.layerStatesArray[e.layerIndex],r=e.viewState,a=r.projection,o=r.resolution,l=r.center,c=e.pixelRatio,d=this.getLayer(),u=d.getSource(),f=u.getRevision(),y=u.getTileGridForProjection(a),h=y.getZForResolution(o,u.zDirection),_=y.getResolution(h),T=u.getKey();this.renderedSourceKey_?this.renderedSourceKey_!==T&&(this.prependStaleKey(this.renderedSourceKey_),this.renderedSourceKey_=T):this.renderedSourceKey_=T;let w=e.extent;const p=u.getTilePixelRatio(c);this.prepareContainer(e,t);const L=this.context.canvas.width,m=this.context.canvas.height,g=s.extent&&Jt(s.extent);g&&(w=ce(w,Jt(s.extent)));const P=_*L/2/p,q=_*m/2/p,O=[l[0]-P,l[1]-q,l[0]+P,l[1]+q],N={};this.renderedTiles.length=0;const I=d.getPreload();if(e.nextExtent){const x=y.getZForResolution(r.nextResolution,u.zDirection),A=ji(e,e.nextExtent);this.enqueueTiles(e,A,x,N,I)}const G=ji(e,w);if(this.enqueueTiles(e,G,h,N,0),I>0&&setTimeout(()=>{this.enqueueTiles(e,G,h-1,N,I-1)},0),!(h in N))return this.container;const M=J(this),z=e.time;for(const x of N[h]){const A=x.getState();if((x instanceof ti||x instanceof Fr)&&A===b.EMPTY)continue;const R=x.tileCoord;if(A===b.LOADED&&x.getAlpha(M,z)===1){x.endTransition(M);continue}if(A!==b.IDLE&&(i=!1),A!==b.ERROR&&(this.renderComplete=!1),this.findStaleTile_(R,N)){Ur(N,x,h),e.animate=!0;continue}if(this.findAltTiles_(y,R,h+1,N))continue;const B=y.getMinZoom();for(let V=h-1;V>=B&&!this.findAltTiles_(y,R,V,N);--V);}const X=_/o*c/p,D=this.getRenderContext(e);gn(this.tempTransform,L/2,m/2,X,X,0,-L/2,-m/2),s.extent&&this.clipUnrotated(D,e,g),u.getInterpolate()||(D.imageSmoothingEnabled=!1),this.preRender(D,e);const W=Object.keys(N).map(Number);W.sort(xs);let k;const v=[],E=[];for(let x=W.length-1;x>=0;--x){const A=W[x],R=u.getTilePixelSize(A,c,a),K=y.getResolution(A)/_,B=R[0]*K*X,V=R[1]*K*X,Z=y.getTileCoordForCoordAndZ(Xe(O),A),de=y.getTileCoordExtent(Z),ge=nt(this.tempTransform,[p*(de[0]-O[0])/_,p*(O[3]-de[3])/_]),le=p*u.getGutterForProjection(a);for(const Le of N[A]){if(Le.getState()!==b.LOADED)continue;const dt=Le.tileCoord,ht=Z[1]-dt[1],Ut=Math.round(ge[0]-(ht-1)*B),ut=Z[2]-dt[2],zt=Math.round(ge[1]-(ut-1)*V),_e=Math.round(ge[0]-ht*B),me=Math.round(ge[1]-ut*V),ft=Ut-_e,gt=zt-me,Pi=W.length===1;let Gt=!1;k=[_e,me,_e+ft,me,_e+ft,me+gt,_e,me+gt];for(let _t=0,es=v.length;_t<es;++_t)if(!Pi&&A<E[_t]){const ne=v[_t];hi([_e,me,_e+ft,me+gt],[ne[0],ne[3],ne[4],ne[7]])&&(Gt||(D.save(),Gt=!0),D.beginPath(),D.moveTo(k[0],k[1]),D.lineTo(k[2],k[3]),D.lineTo(k[4],k[5]),D.lineTo(k[6],k[7]),D.moveTo(ne[6],ne[7]),D.lineTo(ne[4],ne[5]),D.lineTo(ne[2],ne[3]),D.lineTo(ne[0],ne[1]),D.clip())}v.push(k),E.push(A),this.drawTile(Le,e,_e,me,ft,gt,le,Pi),Gt&&D.restore(),this.renderedTiles.unshift(Le),this.updateUsedTiles(e.usedTiles,u,Le)}}if(this.renderedRevision=f,this.renderedResolution=_,this.extentChanged=!this.renderedExtent_||!ei(this.renderedExtent_,O),this.renderedExtent_=O,this.renderedPixelRatio=c,this.postRender(this.context,e),s.extent&&D.restore(),D.imageSmoothingEnabled=!0,this.renderComplete){const x=(A,R)=>{const F=J(u),K=R.wantedTiles[F],B=K?Object.keys(K).length:0;this.updateCacheSize(B),this.tileCache_.expireCache()};e.postRenderFunctions.push(x)}return!this.renderComplete&&!i&&(e.animate=!0),this.container}updateCacheSize(e){this.tileCache_.highWaterMark=Math.max(this.tileCache_.highWaterMark,e*2)}drawTile(e,t,i,s,r,a,o,l){let c;if(e instanceof ii){if(c=St(e.getData()),!c)throw new Error("Rendering array data is not yet supported")}else c=this.getTileImage(e);if(!c)return;const d=this.getRenderContext(t),u=J(this),f=t.layerStatesArray[t.layerIndex],y=f.opacity*(l?e.getAlpha(u,t.time):1),h=y!==d.globalAlpha;h&&(d.save(),d.globalAlpha=y),d.drawImage(c,o,o,c.width-2*o,c.height-2*o,i,s,r,a),h&&d.restore(),y!==f.opacity?t.animate=!0:l&&e.endTransition(u)}getImage(){const e=this.context;return e?e.canvas:null}getTileImage(e){return e.getImage()}updateUsedTiles(e,t,i){const s=J(t);s in e||(e[s]={}),e[s][i.getKey()]=!0}}class Gr extends Nr{constructor(e){super(e)}createRenderer(){return new zr(this,{cacheSize:this.getCacheSize()})}}const At=1/0;class qr{constructor(e,t){this.priorityFunction_=e,this.keyFunction_=t,this.elements_=[],this.priorities_=[],this.queuedElements_={}}clear(){this.elements_.length=0,this.priorities_.length=0,yi(this.queuedElements_)}dequeue(){const e=this.elements_,t=this.priorities_,i=e[0];e.length==1?(e.length=0,t.length=0):(e[0]=e.pop(),t[0]=t.pop(),this.siftUp_(0));const s=this.keyFunction_(i);return delete this.queuedElements_[s],i}enqueue(e){ie(!(this.keyFunction_(e)in this.queuedElements_),"Tried to enqueue an `element` that was already added to the queue");const t=this.priorityFunction_(e);return t!=At?(this.elements_.push(e),this.priorities_.push(t),this.queuedElements_[this.keyFunction_(e)]=!0,this.siftDown_(0,this.elements_.length-1),!0):!1}getCount(){return this.elements_.length}getLeftChildIndex_(e){return e*2+1}getRightChildIndex_(e){return e*2+2}getParentIndex_(e){return e-1>>1}heapify_(){let e;for(e=(this.elements_.length>>1)-1;e>=0;e--)this.siftUp_(e)}isEmpty(){return this.elements_.length===0}isKeyQueued(e){return e in this.queuedElements_}isQueued(e){return this.isKeyQueued(this.keyFunction_(e))}siftUp_(e){const t=this.elements_,i=this.priorities_,s=t.length,r=t[e],a=i[e],o=e;for(;e<s>>1;){const l=this.getLeftChildIndex_(e),c=this.getRightChildIndex_(e),d=c<s&&i[c]<i[l]?c:l;t[e]=t[d],i[e]=i[d],e=d}t[e]=r,i[e]=a,this.siftDown_(o,e)}siftDown_(e,t){const i=this.elements_,s=this.priorities_,r=i[t],a=s[t];for(;t>e;){const o=this.getParentIndex_(t);if(s[o]>a)i[t]=i[o],s[t]=s[o],t=o;else break}i[t]=r,s[t]=a}reprioritize(){const e=this.priorityFunction_,t=this.elements_,i=this.priorities_;let s=0;const r=t.length;let a,o,l;for(o=0;o<r;++o)a=t[o],l=e(a),l==At?delete this.queuedElements_[this.keyFunction_(a)]:(i[s]=l,t[s++]=a);t.length=s,i.length=s,this.heapify_()}}class Xr extends qr{constructor(e,t){super(function(i){return e.apply(null,i)},function(i){return i[0].getKey()}),this.boundHandleTileChange_=this.handleTileChange.bind(this),this.tileChangeCallback_=t,this.tilesLoading_=0,this.tilesLoadingKeys_={}}enqueue(e){const t=super.enqueue(e);return t&&e[0].addEventListener($.CHANGE,this.boundHandleTileChange_),t}getTilesLoading(){return this.tilesLoading_}handleTileChange(e){const t=e.target,i=t.getState();if(i===b.LOADED||i===b.ERROR||i===b.EMPTY){i!==b.ERROR&&t.removeEventListener($.CHANGE,this.boundHandleTileChange_);const s=t.getKey();s in this.tilesLoadingKeys_&&(delete this.tilesLoadingKeys_[s],--this.tilesLoading_),this.tileChangeCallback_()}}loadMoreTiles(e,t){let i=0;for(;this.tilesLoading_<e&&i<t&&this.getCount()>0;){const s=this.dequeue()[0],r=s.getKey();s.getState()===b.IDLE&&!(r in this.tilesLoadingKeys_)&&(this.tilesLoadingKeys_[r]=!0,++this.tilesLoading_,++i,s.load())}}}function Kr(n,e,t,i,s){if(!n||!(t in n.wantedTiles)||!n.wantedTiles[t][e.getKey()])return At;const r=n.viewState.center,a=i[0]-r[0],o=i[1]-r[1];return 65536*Math.log(s)+Math.sqrt(a*a+o*o)/s}class Te extends rt{constructor(e,t){super(e),this.layer=t}}const Ht={LAYERS:"layers"};class We extends ws{constructor(e){e=e||{};const t=Object.assign({},e);delete t.layers;let i=e.layers;super(t),this.on,this.once,this.un,this.layersListenerKeys_=[],this.listenerKeys_={},this.addChangeListener(Ht.LAYERS,this.handleLayersChanged_),i?Array.isArray(i)?i=new ue(i.slice(),{unique:!0}):ie(typeof i.getArray=="function","Expected `layers` to be an array or a `Collection`"):i=new ue(void 0,{unique:!0}),this.setLayers(i)}handleLayerChange_(){this.changed()}handleLayersChanged_(){this.layersListenerKeys_.forEach(ee),this.layersListenerKeys_.length=0;const e=this.getLayers();this.layersListenerKeys_.push(H(e,oe.ADD,this.handleLayersAdd_,this),H(e,oe.REMOVE,this.handleLayersRemove_,this));for(const i in this.listenerKeys_)this.listenerKeys_[i].forEach(ee);yi(this.listenerKeys_);const t=e.getArray();for(let i=0,s=t.length;i<s;i++){const r=t[i];this.registerLayerListeners_(r),this.dispatchEvent(new Te("addlayer",r))}this.changed()}registerLayerListeners_(e){const t=[H(e,Lt.PROPERTYCHANGE,this.handleLayerChange_,this),H(e,$.CHANGE,this.handleLayerChange_,this)];e instanceof We&&t.push(H(e,"addlayer",this.handleLayerGroupAdd_,this),H(e,"removelayer",this.handleLayerGroupRemove_,this)),this.listenerKeys_[J(e)]=t}handleLayerGroupAdd_(e){this.dispatchEvent(new Te("addlayer",e.layer))}handleLayerGroupRemove_(e){this.dispatchEvent(new Te("removelayer",e.layer))}handleLayersAdd_(e){const t=e.element;this.registerLayerListeners_(t),this.dispatchEvent(new Te("addlayer",t)),this.changed()}handleLayersRemove_(e){const t=e.element,i=J(t);this.listenerKeys_[i].forEach(ee),delete this.listenerKeys_[i],this.dispatchEvent(new Te("removelayer",t)),this.changed()}getLayers(){return this.get(Ht.LAYERS)}setLayers(e){const t=this.getLayers();if(t){const i=t.getArray();for(let s=0,r=i.length;s<r;++s)this.dispatchEvent(new Te("removelayer",i[s]))}this.set(Ht.LAYERS,e)}getLayersArray(e){return e=e!==void 0?e:[],this.getLayers().forEach(function(t){t.getLayersArray(e)}),e}getLayerStatesArray(e){const t=e!==void 0?e:[],i=t.length;this.getLayers().forEach(function(a){a.getLayerStatesArray(t)});const s=this.getLayerState();let r=s.zIndex;!e&&s.zIndex===void 0&&(r=0);for(let a=i,o=t.length;a<o;a++){const l=t[a];l.opacity*=s.opacity,l.visible=l.visible&&s.visible,l.maxResolution=Math.min(l.maxResolution,s.maxResolution),l.minResolution=Math.max(l.minResolution,s.minResolution),l.minZoom=Math.max(l.minZoom,s.minZoom),l.maxZoom=Math.min(l.maxZoom,s.maxZoom),s.extent!==void 0&&(l.extent!==void 0?l.extent=ce(l.extent,s.extent):l.extent=s.extent),l.zIndex===void 0&&(l.zIndex=r)}return t}getSourceState(){return"ready"}}function Pn(n){let e="";return n&&n.length>0?n.forEach(t=>{let i=new Date(t.timestamp);const s=i.getHours().toString().padStart(2,"0"),r=i.getMinutes().toString().padStart(2,"0"),a=`${s}:${r}`;e+=`
                <div class="chat-message">
                  <p class="chat-user"><b data-user-id="${t.user_id}">${t.user_name}</b> | ${a}: <span>${t.message}</span></p>
                </div>
            `}):e="Тут пока пусто",e}function Br(n){return`
        <div id="chat" class="chat-container">
          <div id="chat-header" class="chat-header">
            <span id="chat-toggle" class="chat-toggle">&#128172;</span>
          </div>
          <div id="chat-body" class="chat-body">
            ${Pn(n)}
          </div>
          <div id="chat-input" class="chat-input">
            <input type="text" id="message" placeholder="Введите сообщение..." />
          </div>
        </div>
    `}async function $r(n=!1,e=[]){n?await S("/chat",{action:"get_messages"}).then(async t=>{let i=[];t&&t.messages&&t.messages.length>0&&(i=t.messages),document.querySelector("body").insertAdjacentHTML("beforeend",Br(i)),Wr()}).catch(t=>{console.log(t.message)}):(document.querySelector(".chat-body").innerHTML=Pn(e),document.querySelector(".chat-body").scrollTop=document.querySelector(".chat-body").scrollHeight)}function Wr(){const n=document.getElementById("chat-header"),e=document.getElementById("chat"),t=document.getElementById("message");return n.addEventListener("click",function(){e.classList.toggle("active"),e.classList.contains("active")?(document.querySelector(".chat-body").scrollTop=document.querySelector(".chat-body").scrollHeight,t.focus()):t.blur()}),t.addEventListener("focus",function(){e.style.opacity="1"}),t.addEventListener("blur",function(){setTimeout(()=>{document.activeElement!==e&&(e.style.opacity="0.5")},100)}),t.addEventListener("keydown",async i=>{(i.key==="Enter"||i.keyCode===13)&&(i.preventDefault(),await jr(i.target.value.trim())&&(i.target.value=""))}),document.querySelector(".chat-body").scrollTop=document.querySelector(".chat-body").scrollHeight,!0}async function jr(n){if(n!=="")return await S("/chat",{action:"send",message:n}).then(async e=>{e&&e.send}),document.querySelector(".chat-body").scrollTop=document.querySelector(".chat-body").scrollHeight,!0}const Dn={chat:$r},fe=new Map,It=document.querySelector(".info.popup"),Mn=document.querySelector("#modal-content");document.querySelector("#modal-header");const Fn=document.querySelector("#modal-header .modal-title"),On=document.querySelector(".close-button");On.addEventListener("click",Ci);On.addEventListener("touchend",Ci);function Ci(n){n&&n.preventDefault(),It.style.display="none",fe&&fe.forEach((e,t)=>{document.body.contains(e)&&document.body.removeChild(e),fe.delete(t)})}function ri(n,e,t=null){fe&&fe.forEach((i,s)=>{document.body.contains(i)&&document.body.removeChild(i),fe.delete(s)}),Fn.innerHTML=n,Mn.innerHTML=e,It.style.display="flex",document.querySelectorAll(".reward-icon").length>0&&document.querySelectorAll(".reward-icon").forEach(i=>{i.addEventListener("click",s=>{const r=JSON.parse(s.target.getAttribute("data-item"));if(r&&!fe.has(r.id)){const a=s.target.getBoundingClientRect();Yr(r,a.left,a.top),document.querySelectorAll("[data-item-action-equip]")&&document.querySelectorAll("[data-item-action-equip]").forEach(o=>{o.onclick=async l=>{l.preventDefault();let c=l.target.closest(".modal-item").getAttribute("data-id");await S("/player",{action:"item_equip",user_item_id:c}).then(async d=>{(d==null?void 0:d.equipped)===!0&&(C.setSelfInfo(await S("/player",{action:"get_self"})),localStorage.setItem("user_info",JSON.stringify(C.getSelfInfo())),ri(C.getSelfInfo().name,U.drawCharacterWindows(C.getSelfInfo())),U.updateStatusBar(C.getSelfInfo()))})}}),document.querySelectorAll("[data-item-action-destroy]")&&document.querySelectorAll("[data-item-action-destroy]").forEach(o=>{o.onclick=async l=>{l.preventDefault(),kn(async c=>{let d=l.target.closest(".modal-item").getAttribute("data-id");await S("/player",{action:"user_item_delete",user_item_id:d,count:c}),C.setSelfInfo(await S("/player",{action:"get_self"})),ri(C.getSelfInfo().name,U.drawCharacterWindows(C.getSelfInfo())),U.updateStatusBar(C.getSelfInfo())},r.quantity)}})}})}),U.observeNewImages(),Li(It),t&&typeof t=="function"&&t()}function kn(n,e=0){const t=document.querySelector("#confirm-modal"),i=document.querySelector("#modal-cancel-btn"),s=document.querySelector("#modal-confirm-btn"),r=document.getElementById("decrement-btn"),a=document.getElementById("increment-btn"),o=document.getElementById("quantity-input");o.value=1,o.max=e,e&&(document.querySelector(".quantity-selector").style.display="block"),t.style.display="block",r.onclick=()=>{const l=parseInt(o.value,10);l>parseInt(o.min,10)&&(o.value=l-1)},a.onclick=()=>{const l=parseInt(o.value,10);l<parseInt(o.max,10)&&(o.value=l+1)},i.onclick=()=>{t.style.display="none"},s.onclick=()=>{t.style.display="none",n&&n(parseInt(o.value,10))},Li(t)}let Yi=100;function Yr(n,e,t){const i=document.createElement("div");i.classList.add("modal-item");const s=270,r=270,a=10;let o=e+a,l=t+a;o+s>window.innerWidth&&(o=window.innerWidth-s-a),l+r>window.innerHeight&&(l=window.innerHeight-r-a),o=Math.max(0,o),l=Math.max(0,l),i.style.left=`${o}px`,i.style.top=`${l}px`,i.style.zIndex=++Yi,i.setAttribute("data-id",n.user_item_id?n.user_item_id:0);let c=n.user_item_id?"flex":"none";i.innerHTML=U.drawItemInfo(n,c),document.body.appendChild(i),fe.set(n.user_item_id?n.user_item_id:n.item_id,i),i.querySelector(".modal-close").addEventListener("click",()=>{document.body.removeChild(i),fe.delete(n.id)}),i.querySelector(".modal-close").addEventListener("touchend",()=>{document.body.removeChild(i),fe.delete(n.id)}),i.addEventListener("mousedown",()=>{i.style.zIndex=++Yi}),Li(i)}function Li(n){let e=0,t=0,i=!1,s,r;const a=n.querySelector(".modal-header"),o=f=>f.touches&&f.touches.length>0?{x:f.touches[0].clientX,y:f.touches[0].clientY}:{x:f.clientX,y:f.clientY},l=()=>{const f=n.getBoundingClientRect();let y=f.left,h=f.top;f.right>window.innerWidth&&(y=window.innerWidth-f.width),f.left<0&&(y=0),f.bottom>window.innerHeight&&(h=window.innerHeight-f.height),f.top<0&&(h=0),n.style.left=`${y}px`,n.style.top=`${h}px`},c=f=>{if(f.target.id==="closeModal")return;f.preventDefault();const{x:y,y:h}=o(f);s=y,r=h,i=!0,e=n.offsetLeft,t=n.offsetTop,a.style.cursor="grabbing"},d=()=>{i=!1,a.style.cursor="grab"},u=f=>{if(!i)return;f.preventDefault();const{x:y,y:h}=o(f),_=y-s,T=h-r,w=Math.min(window.innerWidth-n.offsetWidth,Math.max(0,e+_)),p=Math.min(window.innerHeight-n.offsetHeight,Math.max(0,t+T));n.style.left=`${w}px`,n.style.top=`${p}px`,n.style.transform="none"};a.addEventListener("mousedown",c),document.addEventListener("mouseup",d),document.addEventListener("mousemove",u),a.addEventListener("touchstart",c,{passive:!1}),document.addEventListener("touchend",d,{passive:!1}),document.addEventListener("touchmove",u,{passive:!1}),l(),window.addEventListener("resize",l)}const j={modalTitle:Fn,modalContent:Mn,modal:It,showModal:ri,closeModalHandler:Ci,openConfirmModal:kn};async function Hr(){var t;let n="";(!C.getUserMails()||((t=C.getUserMails())==null?void 0:t.length)<=0)&&await S("/mail",{action:"get_messages"}).then(i=>{C.setUserMails(i),Ri(C.getUserMails())}).catch(i=>{console.log(i)}),C.getUserMails().forEach(i=>{let s=new Date(i.datetime);const r=s.getFullYear().toString(),a=s.getMonth().toString().padStart(2,"0"),o=s.getDay().toString().padStart(2,"0"),l=s.getHours().toString().padStart(2,"0"),c=s.getMinutes().toString().padStart(2,"0"),d=`${o}.${a}.${r} ${l}:${c}`;n+=`
            <div class="mail-item${i.is_read===!1?" unread":""}" data-id="${i.id}">
                <span>${i.subject}</span>
                <span>${d}</span>
            </div>
            <div class="mail-content" id="mail-${i.id}" style="display: none;">
                <span><strong>От:</strong> ${i.sender_name}</span>
                <h3>${i.subject}</h3>
                <p>${i.message}</p>
                <div class="mail-button"> 
                    <button class="btn close-mail" data-id="${i.id}">Закрыть</button>
                    <button class="btn delete-mail" data-id="${i.id}">Удалить</button>
                </div>
            </div>
        `}),j.showModal("Почта",`
        <div class="mail-container">
            <div class="mail-list">
                ${n||"Писем пока нет"}
            </div>
            <div class="mail-compose" id="compose-mail" style="display: none;">
                <h3>Написать письмо</h3>
                <div class="recipient-wrapper" style="position: relative;">
                    <input class="input-field" autocomplete="off" type="text" placeholder="Получатель (никнейм)" id="recipient">
                    <div id="recipient-suggestions" class="suggestions"></div>
                </div>
                <input class="input-field" type="text" placeholder="Тема" id="subject">
                <textarea class="input-field" placeholder="Сообщение" id="message"></textarea>
                <div class="mail-button"> 
                    <button class="btn" id="send-mail">Отправить</button>
                    <button class="btn" id="close-compose">Отмена</button>
                </div>
            </div>
            <div class="mail-footer">
                <button class="btn" id="open-compose">Написать письмо</button>
            </div>
        </div>
    `,Vr)}const Vr=()=>{const n=document.getElementById("recipient"),e=document.getElementById("recipient-suggestions");let t;n.addEventListener("input",function(i){clearTimeout(t);const s=i.target.value.trim();if(s.length<2){e.innerHTML="",e.style.display="none",n.removeAttribute("data-id");return}t=setTimeout(async()=>{await S("/player",{action:"find_users",query:s}).then(r=>{let a="";r.forEach(o=>{a+=`<div class="suggestion" data-id="${o.id}" style="padding: 5px; cursor: pointer;">${o.username}</div>`}),e.innerHTML=a,e.style.display="flex",document.querySelectorAll("#recipient-suggestions .suggestion").forEach(o=>{o.addEventListener("click",function(){n.value=this.textContent,n.setAttribute("data-id",this.getAttribute("data-id")),e.innerHTML="",e.style.display="none"})})}).catch(r=>{console.log(r)})},300)}),document.querySelectorAll(".mail-item").forEach(i=>{i.addEventListener("click",s=>Zr(i.dataset.id,i))}),document.querySelectorAll(".close-mail").forEach(i=>{i.addEventListener("click",()=>Qr(i.dataset.id))}),document.querySelectorAll(".delete-mail").forEach(i=>{i.addEventListener("click",()=>Jr(i.dataset.id))}),document.getElementById("open-compose").addEventListener("click",ea),document.getElementById("close-compose").addEventListener("click",Nn),document.getElementById("send-mail").addEventListener("click",ta)};async function Zr(n,e){document.querySelectorAll(".mail-content").forEach(t=>t.style.display="none"),document.getElementById("mail-"+n).style.display="block",e.classList.contains("unread")&&(e.classList.remove("unread"),await S("/mail",{action:"read",mail_id:n}).then(t=>{if((t==null?void 0:t.read)===!0){let i=[];C.getUserMails().forEach(s=>{s.id===parseInt(n)&&(s.is_read=!0),i.push(s)}),C.setUserMails(i),Ri(i)}}).catch(t=>{console.log(t)}))}function Qr(n){document.getElementById("mail-"+n).style.display="none"}async function Jr(n){await S("/mail",{action:"delete",mail_id:n}).then(e=>{if(e!=null&&e.deleted&&(e==null?void 0:e.deleted)===!0){const t=document.getElementById("mail-"+n),i=document.querySelector('.mail-item[data-id="'+n+'"]');t&&t.classList.add("fade-out"),i&&i.classList.add("fade-out"),setTimeout(()=>{t&&t.remove(),i&&i.remove()},300)}}).catch(e=>{console.log(e)})}function ea(){document.getElementById("compose-mail").style.display="block"}function Nn(){document.getElementById("compose-mail").style.display="none"}async function ta(){const n=document.getElementById("recipient"),e=n.getAttribute("data-id"),t=document.getElementById("subject").value.trim(),i=document.getElementById("message").value.trim();if(!e||!t||!i){U.createToast("Все поля обязательны для заполнения!");return}if(t.length>100){U.createToast("Тема письма не должна превышать 100 символов!");return}if(i.length>1e3){U.createToast("Сообщение не должно превышать 1000 символов!");return}await S("/mail",{action:"send",recipient_id:e,subject:t,message:i}).then(s=>{Nn(),document.getElementById("subject").value="",document.getElementById("message").value="",n.value=""}).catch(s=>{console.log(s)})}function Ri(n){let e=0;if(n&&n){n.forEach(i=>{i.is_read===!1&&e++});const t=document.querySelector(".notification-badge-mail");e>0?(t.innerText=e,t.style.display="block"):t.style.display="none"}}const ai={getMail:Hr,updateCountMail:Ri};let oi=[],xe=null,Pt=!1;const Je={},ia="wss://"+window.location.host+"/ws";function Un(n){xe=new WebSocket(`${ia}?token=${n}`),xe.onopen=async()=>{Pt=!0,console.log("WebSocket connection established");let e=0;for(;oi.length>0;)xe.send(oi.shift()),console.log("WebSocket queue send: "+e),e++},xe.onmessage=async e=>{try{const t=JSON.parse(e.data);console.log("Parsed response:",t);const{id:i,action:s,data:r,success:a,message:o,successMessage:l}=t;if(console.log(i,s,r,a,o,l),t.data&&t.data.successMessage?U.createToast(t.data.successMessage):t.data&&t.data.message&&U.createToast(t.data.message),Je[i])a?(r.detail==="Invalid token"&&(C.getRefreshToken()?(await Mi(),C.setToken(localStorage.getItem("jwt"))):(U.redirectToAuth(),U.createToast("Unauthorized: Redirecting to auth..."))),Je[i].resolve(r)):Je[i].reject(a),delete Je[i];else if(s)switch(l&&l.length>0?U.createToast(l):o&&o.length>0&&U.createToast(o),s){case"update_quests":C.setUserQuests(await S("/quest",{action:"get_user_quest"}));break;case"update_chat":await Dn.chat(!1,r.messages);break;case"update_mail":C.setUserMails(await S("/mail",{action:"get_messages"})),ai.updateCountMail(C.getUserMails());break}else console.warn(`No handler found for response ID: ${i}`)}catch(t){console.error("Failed to parse message:",t)}},xe.onclose=async e=>{Pt=!1,C.getRefreshToken()?(await Mi(),C.setToken(localStorage.getItem("jwt"))):(U.redirectToAuth(),U.createToast("Unauthorized: Redirecting to auth...")),console.log("WebSocket connection closed. Reconnecting..."),U.createToast("Соединение потеряно. Подключаемся..."),setTimeout(()=>Un(C.getToken()),2e3)},xe.onerror=e=>{console.error("WebSocket error:",e)}}function na(n){Pt?n():xe.addEventListener("open",n)}async function sa(n,e=null){const t=Math.random().toString(36).substr(2,9),i={id:t,endpoint:n,body:e};return Pt?new Promise((s,r)=>{Je[t]={resolve:s,reject:r},xe.send(JSON.stringify(i))}):(console.error("WebSocket is not ready"),oi.push(JSON.stringify(i)),null)}async function S(n,e=null){try{const t=await sa(n,e);if(t&&t.success)return t.successMessage&&t.successMessage.length,t.data;if(t&&t.message&&t.message.length)return null}catch(t){console.error("Error:",t)}}Un(C.getToken());class ra{constructor(e,t,i){this.decay_=e,this.minVelocity_=t,this.delay_=i,this.points_=[],this.angle_=0,this.initialVelocity_=0}begin(){this.points_.length=0,this.angle_=0,this.initialVelocity_=0}update(e,t){this.points_.push(e,t,Date.now())}end(){if(this.points_.length<6)return!1;const e=Date.now()-this.delay_,t=this.points_.length-3;if(this.points_[t+2]<e)return!1;let i=t-3;for(;i>0&&this.points_[i+2]>e;)i-=3;const s=this.points_[t+2]-this.points_[i+2];if(s<1e3/60)return!1;const r=this.points_[t]-this.points_[i],a=this.points_[t+1]-this.points_[i+1];return this.angle_=Math.atan2(a,r),this.initialVelocity_=Math.sqrt(r*r+a*a)/s,this.initialVelocity_>this.minVelocity_}getDistance(){return(this.minVelocity_-this.initialVelocity_)/this.decay_}getAngle(){return this.angle_}}class aa extends ui{constructor(e){super(),this.map_=e}dispatchRenderEvent(e,t){Ct()}calculateMatrices2D(e){const t=e.viewState,i=e.coordinateToPixelTransform,s=e.pixelToCoordinateTransform;gn(i,e.size[0]/2,e.size[1]/2,1/t.resolution,-1/t.resolution,-t.rotation,-t.center[0],-t.center[1]),bs(s,i)}forEachFeatureAtCoordinate(e,t,i,s,r,a,o,l){let c;const d=t.viewState;function u(m,g,P,q){return r.call(a,g,m?P:null,q)}const f=d.projection,y=Cs(e.slice(),f),h=[[0,0]];if(f.canWrapX()&&s){const m=f.getExtent(),g=Q(m);h.push([-g,0],[g,0])}const _=t.layerStatesArray,T=_.length,w=[],p=[];for(let m=0;m<h.length;m++)for(let g=T-1;g>=0;--g){const P=_[g],q=P.layer;if(q.hasRenderer()&&_n(P,d)&&o.call(l,q)){const O=q.getRenderer(),N=q.getSource();if(O&&N){const I=N.getWrapX()?y:e,G=u.bind(null,P.managed);p[0]=I[0]+h[m][0],p[1]=I[1]+h[m][1],c=O.forEachFeatureAtCoordinate(p,t,i,G,w)}if(c)return c}}if(w.length===0)return;const L=1/w.length;return w.forEach((m,g)=>m.distanceSq+=g*L),w.sort((m,g)=>m.distanceSq-g.distanceSq),w.some(m=>c=m.callback(m.feature,m.layer,m.geometry)),c}hasFeatureAtCoordinate(e,t,i,s,r,a){return this.forEachFeatureAtCoordinate(e,t,i,s,Be,this,r,a)!==void 0}getMap(){return this.map_}renderFrame(e){Ct()}scheduleExpireIconCache(e){mn.canExpireCache()&&e.postRenderFunctions.push(oa)}}function oa(n,e){mn.expire()}class la extends aa{constructor(e){super(e),this.fontChangeListenerKey_=H(Ls,Lt.PROPERTYCHANGE,e.redrawText,e),this.element_=document.createElement("div");const t=this.element_.style;t.position="absolute",t.width="100%",t.height="100%",t.zIndex="0",this.element_.className=at+" ol-layers";const i=e.getViewport();i.insertBefore(this.element_,i.firstChild||null),this.children_=[],this.renderedVisible_=!0}dispatchRenderEvent(e,t){const i=this.getMap();if(i.hasListener(e)){const s=new Rs(e,void 0,t);i.dispatchEvent(s)}}disposeInternal(){ee(this.fontChangeListenerKey_),this.element_.remove(),super.disposeInternal()}renderFrame(e){if(!e){this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1);return}this.calculateMatrices2D(e),this.dispatchRenderEvent(et.PRECOMPOSE,e);const t=e.layerStatesArray.sort((o,l)=>o.zIndex-l.zIndex);t.some(o=>o.layer instanceof Ss&&o.layer.getDeclutter())&&(e.declutter={});const s=e.viewState;this.children_.length=0;const r=[];let a=null;for(let o=0,l=t.length;o<l;++o){const c=t[o];e.layerIndex=o;const d=c.layer,u=d.getSourceState();if(!_n(c,s)||u!="ready"&&u!="undefined"){d.unrender();continue}const f=d.render(e,a);f&&(f!==a&&(this.children_.push(f),a=f),r.push(c))}this.declutter(e,r),As(this.element_,this.children_),this.dispatchRenderEvent(et.POSTCOMPOSE,e),this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0),this.scheduleExpireIconCache(e)}declutter(e,t){if(e.declutter){for(let i=t.length-1;i>=0;--i){const s=t[i],r=s.layer;r.getDeclutter()&&r.renderDeclutter(e,s)}t.forEach(i=>i.layer.renderDeferred(e))}}}class ke extends rt{constructor(e,t,i){super(e),this.map=t,this.frameState=i!==void 0?i:null}}class Ee extends ke{constructor(e,t,i,s,r,a){super(e,t,r),this.originalEvent=i,this.pixel_=null,this.coordinate_=null,this.dragging=s!==void 0?s:!1,this.activePointers=a}get pixel(){return this.pixel_||(this.pixel_=this.map.getEventPixel(this.originalEvent)),this.pixel_}set pixel(e){this.pixel_=e}get coordinate(){return this.coordinate_||(this.coordinate_=this.map.getCoordinateFromPixel(this.pixel)),this.coordinate_}set coordinate(e){this.coordinate_=e}preventDefault(){super.preventDefault(),"preventDefault"in this.originalEvent&&this.originalEvent.preventDefault()}stopPropagation(){super.stopPropagation(),"stopPropagation"in this.originalEvent&&this.originalEvent.stopPropagation()}}const Y={SINGLECLICK:"singleclick",CLICK:$.CLICK,DBLCLICK:$.DBLCLICK,POINTERDRAG:"pointerdrag",POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROVER:"pointerover",POINTEROUT:"pointerout",POINTERENTER:"pointerenter",POINTERLEAVE:"pointerleave",POINTERCANCEL:"pointercancel"},li={POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROVER:"pointerover",POINTEROUT:"pointerout",POINTERENTER:"pointerenter",POINTERLEAVE:"pointerleave",POINTERCANCEL:"pointercancel"};class ca extends ln{constructor(e,t){super(e),this.map_=e,this.clickTimeoutId_,this.emulateClicks_=!1,this.dragging_=!1,this.dragListenerKeys_=[],this.moveTolerance_=t===void 0?1:t,this.down_=null;const i=this.map_.getViewport();this.activePointers_=[],this.trackedTouches_={},this.element_=i,this.pointerdownListenerKey_=H(i,li.POINTERDOWN,this.handlePointerDown_,this),this.originalPointerMoveEvent_,this.relayedListenerKey_=H(i,li.POINTERMOVE,this.relayMoveEvent_,this),this.boundHandleTouchMove_=this.handleTouchMove_.bind(this),this.element_.addEventListener($.TOUCHMOVE,this.boundHandleTouchMove_,yn?{passive:!1}:!1)}emulateClick_(e){let t=new Ee(Y.CLICK,this.map_,e);this.dispatchEvent(t),this.clickTimeoutId_!==void 0?(clearTimeout(this.clickTimeoutId_),this.clickTimeoutId_=void 0,t=new Ee(Y.DBLCLICK,this.map_,e),this.dispatchEvent(t)):this.clickTimeoutId_=setTimeout(()=>{this.clickTimeoutId_=void 0;const i=new Ee(Y.SINGLECLICK,this.map_,e);this.dispatchEvent(i)},250)}updateActivePointers_(e){const t=e,i=t.pointerId;if(t.type==Y.POINTERUP||t.type==Y.POINTERCANCEL){delete this.trackedTouches_[i];for(const s in this.trackedTouches_)if(this.trackedTouches_[s].target!==t.target){delete this.trackedTouches_[s];break}}else(t.type==Y.POINTERDOWN||t.type==Y.POINTERMOVE)&&(this.trackedTouches_[i]=t);this.activePointers_=Object.values(this.trackedTouches_)}handlePointerUp_(e){this.updateActivePointers_(e);const t=new Ee(Y.POINTERUP,this.map_,e,void 0,void 0,this.activePointers_);this.dispatchEvent(t),this.emulateClicks_&&!t.defaultPrevented&&!this.dragging_&&this.isMouseActionButton_(e)&&this.emulateClick_(this.down_),this.activePointers_.length===0&&(this.dragListenerKeys_.forEach(ee),this.dragListenerKeys_.length=0,this.dragging_=!1,this.down_=null)}isMouseActionButton_(e){return e.button===0}handlePointerDown_(e){this.emulateClicks_=this.activePointers_.length===0,this.updateActivePointers_(e);const t=new Ee(Y.POINTERDOWN,this.map_,e,void 0,void 0,this.activePointers_);if(this.dispatchEvent(t),this.down_=new PointerEvent(e.type,e),Object.defineProperty(this.down_,"target",{writable:!1,value:e.target}),this.dragListenerKeys_.length===0){const i=this.map_.getOwnerDocument();this.dragListenerKeys_.push(H(i,Y.POINTERMOVE,this.handlePointerMove_,this),H(i,Y.POINTERUP,this.handlePointerUp_,this),H(this.element_,Y.POINTERCANCEL,this.handlePointerUp_,this)),this.element_.getRootNode&&this.element_.getRootNode()!==i&&this.dragListenerKeys_.push(H(this.element_.getRootNode(),Y.POINTERUP,this.handlePointerUp_,this))}}handlePointerMove_(e){if(this.isMoving_(e)){this.updateActivePointers_(e),this.dragging_=!0;const t=new Ee(Y.POINTERDRAG,this.map_,e,this.dragging_,void 0,this.activePointers_);this.dispatchEvent(t)}}relayMoveEvent_(e){this.originalPointerMoveEvent_=e;const t=!!(this.down_&&this.isMoving_(e));this.dispatchEvent(new Ee(Y.POINTERMOVE,this.map_,e,t))}handleTouchMove_(e){const t=this.originalPointerMoveEvent_;(!t||t.defaultPrevented)&&(typeof e.cancelable!="boolean"||e.cancelable===!0)&&e.preventDefault()}isMoving_(e){return this.dragging_||Math.abs(e.clientX-this.down_.clientX)>this.moveTolerance_||Math.abs(e.clientY-this.down_.clientY)>this.moveTolerance_}disposeInternal(){this.relayedListenerKey_&&(ee(this.relayedListenerKey_),this.relayedListenerKey_=null),this.element_.removeEventListener($.TOUCHMOVE,this.boundHandleTouchMove_),this.pointerdownListenerKey_&&(ee(this.pointerdownListenerKey_),this.pointerdownListenerKey_=null),this.dragListenerKeys_.forEach(ee),this.dragListenerKeys_.length=0,this.element_=null,super.disposeInternal()}}const ve={POSTRENDER:"postrender",MOVESTART:"movestart",MOVEEND:"moveend",LOADSTART:"loadstart",LOADEND:"loadend"},te={LAYERGROUP:"layergroup",SIZE:"size",TARGET:"target",VIEW:"view"};class Nt extends pi{constructor(e){super();const t=e.element;t&&!e.target&&!t.style.pointerEvents&&(t.style.pointerEvents="auto"),this.element=t||null,this.target_=null,this.map_=null,this.listenerKeys=[],e.render&&(this.render=e.render),e.target&&this.setTarget(e.target)}disposeInternal(){var e;(e=this.element)==null||e.remove(),super.disposeInternal()}getMap(){return this.map_}setMap(e){var t;this.map_&&((t=this.element)==null||t.remove());for(let i=0,s=this.listenerKeys.length;i<s;++i)ee(this.listenerKeys[i]);if(this.listenerKeys.length=0,this.map_=e,e){const i=this.target_??e.getOverlayContainerStopEvent();this.element&&i.appendChild(this.element),this.render!==Is&&this.listenerKeys.push(H(e,ve.POSTRENDER,this.render,this)),e.render()}}render(e){}setTarget(e){this.target_=typeof e=="string"?document.getElementById(e):e}}class da extends Nt{constructor(e){e=e||{},super({element:document.createElement("div"),render:e.render,target:e.target}),this.ulElement_=document.createElement("ul"),this.collapsed_=e.collapsed!==void 0?e.collapsed:!0,this.userCollapsed_=this.collapsed_,this.overrideCollapsible_=e.collapsible!==void 0,this.collapsible_=e.collapsible!==void 0?e.collapsible:!0,this.collapsible_||(this.collapsed_=!1),this.attributions_=e.attributions;const t=e.className!==void 0?e.className:"ol-attribution",i=e.tipLabel!==void 0?e.tipLabel:"Attributions",s=e.expandClassName!==void 0?e.expandClassName:t+"-expand",r=e.collapseLabel!==void 0?e.collapseLabel:"›",a=e.collapseClassName!==void 0?e.collapseClassName:t+"-collapse";typeof r=="string"?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=r,this.collapseLabel_.className=a):this.collapseLabel_=r;const o=e.label!==void 0?e.label:"i";typeof o=="string"?(this.label_=document.createElement("span"),this.label_.textContent=o,this.label_.className=s):this.label_=o;const l=this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_;this.toggleButton_=document.createElement("button"),this.toggleButton_.setAttribute("type","button"),this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_)),this.toggleButton_.title=i,this.toggleButton_.appendChild(l),this.toggleButton_.addEventListener($.CLICK,this.handleClick_.bind(this),!1);const c=t+" "+at+" "+Ei+(this.collapsed_&&this.collapsible_?" "+Fi:"")+(this.collapsible_?"":" ol-uncollapsible"),d=this.element;d.className=c,d.appendChild(this.toggleButton_),d.appendChild(this.ulElement_),this.renderedAttributions_=[],this.renderedVisible_=!0}collectSourceAttributions_(e){const t=this.getMap().getAllLayers(),i=new Set(t.flatMap(s=>s.getAttributions(e)));if(this.attributions_!==void 0&&(Array.isArray(this.attributions_)?this.attributions_.forEach(s=>i.add(s)):i.add(this.attributions_)),!this.overrideCollapsible_){const s=!t.some(r=>{var a;return((a=r.getSource())==null?void 0:a.getAttributionsCollapsible())===!1});this.setCollapsible(s)}return Array.from(i)}async updateElement_(e){if(!e){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const t=await Promise.all(this.collectSourceAttributions_(e).map(s=>Ps(()=>s))),i=t.length>0;if(this.renderedVisible_!=i&&(this.element.style.display=i?"":"none",this.renderedVisible_=i),!pn(t,this.renderedAttributions_)){Ds(this.ulElement_);for(let s=0,r=t.length;s<r;++s){const a=document.createElement("li");a.innerHTML=t[s],this.ulElement_.appendChild(a)}this.renderedAttributions_=t}}handleClick_(e){e.preventDefault(),this.handleToggle_(),this.userCollapsed_=this.collapsed_}handleToggle_(){this.element.classList.toggle(Fi),this.collapsed_?Oi(this.collapseLabel_,this.label_):Oi(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_,this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_))}getCollapsible(){return this.collapsible_}setCollapsible(e){this.collapsible_!==e&&(this.collapsible_=e,this.element.classList.toggle("ol-uncollapsible"),this.userCollapsed_&&this.handleToggle_())}setCollapsed(e){this.userCollapsed_=e,!(!this.collapsible_||this.collapsed_===e)&&this.handleToggle_()}getCollapsed(){return this.collapsed_}render(e){this.updateElement_(e.frameState)}}class ha extends Nt{constructor(e){e=e||{},super({element:document.createElement("div"),render:e.render,target:e.target});const t=e.className!==void 0?e.className:"ol-rotate",i=e.label!==void 0?e.label:"⇧",s=e.compassClassName!==void 0?e.compassClassName:"ol-compass";this.label_=null,typeof i=="string"?(this.label_=document.createElement("span"),this.label_.className=s,this.label_.textContent=i):(this.label_=i,this.label_.classList.add(s));const r=e.tipLabel?e.tipLabel:"Reset rotation",a=document.createElement("button");a.className=t+"-reset",a.setAttribute("type","button"),a.title=r,a.appendChild(this.label_),a.addEventListener($.CLICK,this.handleClick_.bind(this),!1);const o=t+" "+at+" "+Ei,l=this.element;l.className=o,l.appendChild(a),this.callResetNorth_=e.resetNorth?e.resetNorth:void 0,this.duration_=e.duration!==void 0?e.duration:250,this.autoHide_=e.autoHide!==void 0?e.autoHide:!0,this.rotation_=void 0,this.autoHide_&&this.element.classList.add(pt)}handleClick_(e){e.preventDefault(),this.callResetNorth_!==void 0?this.callResetNorth_():this.resetNorth_()}resetNorth_(){const t=this.getMap().getView();if(!t)return;const i=t.getRotation();i!==void 0&&(this.duration_>0&&i%(2*Math.PI)!==0?t.animate({rotation:0,duration:this.duration_,easing:ot}):t.setRotation(0))}render(e){const t=e.frameState;if(!t)return;const i=t.viewState.rotation;if(i!=this.rotation_){const s="rotate("+i+"rad)";if(this.autoHide_){const r=this.element.classList.contains(pt);!r&&i===0?this.element.classList.add(pt):r&&i!==0&&this.element.classList.remove(pt)}this.label_.style.transform=s}this.rotation_=i}}class ua extends Nt{constructor(e){e=e||{},super({element:document.createElement("div"),target:e.target});const t=e.className!==void 0?e.className:"ol-zoom",i=e.delta!==void 0?e.delta:1,s=e.zoomInClassName!==void 0?e.zoomInClassName:t+"-in",r=e.zoomOutClassName!==void 0?e.zoomOutClassName:t+"-out",a=e.zoomInLabel!==void 0?e.zoomInLabel:"+",o=e.zoomOutLabel!==void 0?e.zoomOutLabel:"–",l=e.zoomInTipLabel!==void 0?e.zoomInTipLabel:"Zoom in",c=e.zoomOutTipLabel!==void 0?e.zoomOutTipLabel:"Zoom out",d=document.createElement("button");d.className=s,d.setAttribute("type","button"),d.title=l,d.appendChild(typeof a=="string"?document.createTextNode(a):a),d.addEventListener($.CLICK,this.handleClick_.bind(this,i),!1);const u=document.createElement("button");u.className=r,u.setAttribute("type","button"),u.title=c,u.appendChild(typeof o=="string"?document.createTextNode(o):o),u.addEventListener($.CLICK,this.handleClick_.bind(this,-i),!1);const f=t+" "+at+" "+Ei,y=this.element;y.className=f,y.appendChild(d),y.appendChild(u),this.duration_=e.duration!==void 0?e.duration:250}handleClick_(e,t){t.preventDefault(),this.zoomByDelta_(e)}zoomByDelta_(e){const i=this.getMap().getView();if(!i)return;const s=i.getZoom();if(s!==void 0){const r=i.getConstrainedZoom(s+e);this.duration_>0?(i.getAnimating()&&i.cancelAnimations(),i.animate({zoom:r,duration:this.duration_,easing:ot})):i.setZoom(r)}}}function zn(n){n=n||{};const e=new ue;return(n.zoom!==void 0?n.zoom:!0)&&e.push(new ua(n.zoomOptions)),(n.rotate!==void 0?n.rotate:!0)&&e.push(new ha(n.rotateOptions)),(n.attribution!==void 0?n.attribution:!0)&&e.push(new da(n.attributionOptions)),e}const Hi={ACTIVE:"active"};class je extends pi{constructor(e){super(),this.on,this.once,this.un,e&&e.handleEvent&&(this.handleEvent=e.handleEvent),this.map_=null,this.setActive(!0)}getActive(){return this.get(Hi.ACTIVE)}getMap(){return this.map_}handleEvent(e){return!0}setActive(e){this.set(Hi.ACTIVE,e)}setMap(e){this.map_=e}}function fa(n,e,t){const i=n.getCenterInternal();if(i){const s=[i[0]+e[0],i[1]+e[1]];n.animateInternal({duration:t!==void 0?t:250,easing:Ms,center:n.getConstrainedCenter(s)})}}function Si(n,e,t,i){const s=n.getZoom();if(s===void 0)return;const r=n.getConstrainedZoom(s+e),a=n.getResolutionForZoom(r);n.getAnimating()&&n.cancelAnimations(),n.animate({resolution:a,anchor:t,duration:i!==void 0?i:250,easing:ot})}class ga extends je{constructor(e){super(),e=e||{},this.delta_=e.delta?e.delta:1,this.duration_=e.duration!==void 0?e.duration:250}handleEvent(e){let t=!1;if(e.type==Y.DBLCLICK){const i=e.originalEvent,s=e.map,r=e.coordinate,a=i.shiftKey?-this.delta_:this.delta_,o=s.getView();Si(o,a,r,this.duration_),i.preventDefault(),t=!0}return!t}}class ct extends je{constructor(e){e=e||{},super(e),e.handleDownEvent&&(this.handleDownEvent=e.handleDownEvent),e.handleDragEvent&&(this.handleDragEvent=e.handleDragEvent),e.handleMoveEvent&&(this.handleMoveEvent=e.handleMoveEvent),e.handleUpEvent&&(this.handleUpEvent=e.handleUpEvent),e.stopDown&&(this.stopDown=e.stopDown),this.handlingDownUpSequence=!1,this.targetPointers=[]}getPointerCount(){return this.targetPointers.length}handleDownEvent(e){return!1}handleDragEvent(e){}handleEvent(e){if(!e.originalEvent)return!0;let t=!1;if(this.updateTrackedPointers_(e),this.handlingDownUpSequence){if(e.type==Y.POINTERDRAG)this.handleDragEvent(e),e.originalEvent.preventDefault();else if(e.type==Y.POINTERUP){const i=this.handleUpEvent(e);this.handlingDownUpSequence=i&&this.targetPointers.length>0}}else if(e.type==Y.POINTERDOWN){const i=this.handleDownEvent(e);this.handlingDownUpSequence=i,t=this.stopDown(i)}else e.type==Y.POINTERMOVE&&this.handleMoveEvent(e);return!t}handleMoveEvent(e){}handleUpEvent(e){return!1}stopDown(e){return e}updateTrackedPointers_(e){e.activePointers&&(this.targetPointers=e.activePointers)}}function Ai(n){const e=n.length;let t=0,i=0;for(let s=0;s<e;s++)t+=n[s].clientX,i+=n[s].clientY;return{clientX:t/e,clientY:i/e}}function ci(n){const e=arguments;return function(t){let i=!0;for(let s=0,r=e.length;s<r&&(i=i&&e[s](t),!!i);++s);return i}}const _a=function(n){const e=n.originalEvent;return e.altKey&&!(e.metaKey||e.ctrlKey)&&e.shiftKey},ma=function(n){const e=n.map.getTargetElement(),t=e.getRootNode(),i=n.map.getOwnerDocument().activeElement;return t instanceof ShadowRoot?t.host.contains(i):e.contains(i)},Gn=function(n){const e=n.map.getTargetElement(),t=e.getRootNode();return(t instanceof ShadowRoot?t.host:e).hasAttribute("tabindex")?ma(n):!0},ya=Be,pa=function(n){return n.type==Y.CLICK},qn=function(n){const e=n.originalEvent;return e.button==0&&!(Fs&&En&&e.ctrlKey)},Vi=lt,Ea=function(n){return n.type==Y.SINGLECLICK},Xn=function(n){const e=n.originalEvent;return!e.altKey&&!(e.metaKey||e.ctrlKey)&&!e.shiftKey},va=function(n){const e=n.originalEvent;return En?e.metaKey:e.ctrlKey},Kn=function(n){const e=n.originalEvent;return!e.altKey&&!(e.metaKey||e.ctrlKey)&&e.shiftKey},Bn=function(n){const e=n.originalEvent,t=e.target.tagName;return t!=="INPUT"&&t!=="SELECT"&&t!=="TEXTAREA"&&!e.target.isContentEditable},Vt=function(n){const e=n.originalEvent;return ie(e!==void 0,"mapBrowserEvent must originate from a pointer event"),e.pointerType=="mouse"},Ta=function(n){const e=n.originalEvent;return ie(e!==void 0,"mapBrowserEvent must originate from a pointer event"),e.isPrimary&&e.button===0};class xa extends ct{constructor(e){super({stopDown:lt}),e=e||{},this.kinetic_=e.kinetic,this.lastCentroid=null,this.lastPointersCount_,this.panning_=!1;const t=e.condition?e.condition:ci(Xn,Ta);this.condition_=e.onFocusOnly?ci(Gn,t):t,this.noKinetic_=!1}handleDragEvent(e){const t=e.map;this.panning_||(this.panning_=!0,t.getView().beginInteraction());const i=this.targetPointers,s=t.getEventPixel(Ai(i));if(i.length==this.lastPointersCount_){if(this.kinetic_&&this.kinetic_.update(s[0],s[1]),this.lastCentroid){const r=[this.lastCentroid[0]-s[0],s[1]-this.lastCentroid[1]],o=e.map.getView();Os(r,o.getResolution()),vn(r,o.getRotation()),o.adjustCenterInternal(r)}}else this.kinetic_&&this.kinetic_.begin();this.lastCentroid=s,this.lastPointersCount_=i.length,e.originalEvent.preventDefault()}handleUpEvent(e){const t=e.map,i=t.getView();if(this.targetPointers.length===0){if(!this.noKinetic_&&this.kinetic_&&this.kinetic_.end()){const s=this.kinetic_.getDistance(),r=this.kinetic_.getAngle(),a=i.getCenterInternal(),o=t.getPixelFromCoordinateInternal(a),l=t.getCoordinateFromPixelInternal([o[0]-s*Math.cos(r),o[1]-s*Math.sin(r)]);i.animateInternal({center:i.getConstrainedCenter(l),duration:500,easing:ot})}return this.panning_&&(this.panning_=!1,i.endInteraction()),!1}return this.kinetic_&&this.kinetic_.begin(),this.lastCentroid=null,!0}handleDownEvent(e){if(this.targetPointers.length>0&&this.condition_(e)){const i=e.map.getView();return this.lastCentroid=null,i.getAnimating()&&i.cancelAnimations(),this.kinetic_&&this.kinetic_.begin(),this.noKinetic_=this.targetPointers.length>1,!0}return!1}}class wa extends ct{constructor(e){e=e||{},super({stopDown:lt}),this.condition_=e.condition?e.condition:_a,this.lastAngle_=void 0,this.duration_=e.duration!==void 0?e.duration:250}handleDragEvent(e){if(!Vt(e))return;const t=e.map,i=t.getView();if(i.getConstraints().rotation===Tn)return;const s=t.getSize(),r=e.pixel,a=Math.atan2(s[1]/2-r[1],r[0]-s[0]/2);if(this.lastAngle_!==void 0){const o=a-this.lastAngle_;i.adjustRotationInternal(-o)}this.lastAngle_=a}handleUpEvent(e){return Vt(e)?(e.map.getView().endInteraction(this.duration_),!1):!0}handleDownEvent(e){return Vt(e)&&qn(e)&&this.condition_(e)?(e.map.getView().beginInteraction(),this.lastAngle_=void 0,!0):!1}}class ba extends ui{constructor(e){super(),this.geometry_=null,this.element_=document.createElement("div"),this.element_.style.position="absolute",this.element_.style.pointerEvents="auto",this.element_.className="ol-box "+e,this.map_=null,this.startPixel_=null,this.endPixel_=null}disposeInternal(){this.setMap(null)}render_(){const e=this.startPixel_,t=this.endPixel_,i="px",s=this.element_.style;s.left=Math.min(e[0],t[0])+i,s.top=Math.min(e[1],t[1])+i,s.width=Math.abs(t[0]-e[0])+i,s.height=Math.abs(t[1]-e[1])+i}setMap(e){if(this.map_){this.map_.getOverlayContainer().removeChild(this.element_);const t=this.element_.style;t.left="inherit",t.top="inherit",t.width="inherit",t.height="inherit"}this.map_=e,this.map_&&this.map_.getOverlayContainer().appendChild(this.element_)}setPixels(e,t){this.startPixel_=e,this.endPixel_=t,this.createOrUpdateGeometry(),this.render_()}createOrUpdateGeometry(){if(!this.map_)return;const e=this.startPixel_,t=this.endPixel_,s=[e,[e[0],t[1]],t,[t[0],e[1]]].map(this.map_.getCoordinateFromPixelInternal,this.map_);s[4]=s[0].slice(),this.geometry_?this.geometry_.setCoordinates([s]):this.geometry_=new ks([s])}getGeometry(){return this.geometry_}}const Fe={BOXSTART:"boxstart",BOXDRAG:"boxdrag",BOXEND:"boxend",BOXCANCEL:"boxcancel"};class He extends rt{constructor(e,t,i){super(e),this.coordinate=t,this.mapBrowserEvent=i}}class Ca extends ct{constructor(e){super(),this.on,this.once,this.un,e=e??{},this.box_=new ba(e.className||"ol-dragbox"),this.minArea_=e.minArea??64,e.onBoxEnd&&(this.onBoxEnd=e.onBoxEnd),this.startPixel_=null,this.condition_=e.condition??qn,this.boxEndCondition_=e.boxEndCondition??this.defaultBoxEndCondition}defaultBoxEndCondition(e,t,i){const s=i[0]-t[0],r=i[1]-t[1];return s*s+r*r>=this.minArea_}getGeometry(){return this.box_.getGeometry()}handleDragEvent(e){this.startPixel_&&(this.box_.setPixels(this.startPixel_,e.pixel),this.dispatchEvent(new He(Fe.BOXDRAG,e.coordinate,e)))}handleUpEvent(e){if(!this.startPixel_)return!1;const t=this.boxEndCondition_(e,this.startPixel_,e.pixel);return t&&this.onBoxEnd(e),this.dispatchEvent(new He(t?Fe.BOXEND:Fe.BOXCANCEL,e.coordinate,e)),this.box_.setMap(null),this.startPixel_=null,!1}handleDownEvent(e){return this.condition_(e)?(this.startPixel_=e.pixel,this.box_.setMap(e.map),this.box_.setPixels(this.startPixel_,this.startPixel_),this.dispatchEvent(new He(Fe.BOXSTART,e.coordinate,e)),!0):!1}onBoxEnd(e){}setActive(e){e||(this.box_.setMap(null),this.startPixel_&&(this.dispatchEvent(new He(Fe.BOXCANCEL,this.startPixel_,null)),this.startPixel_=null)),super.setActive(e)}setMap(e){this.getMap()&&(this.box_.setMap(null),this.startPixel_&&(this.dispatchEvent(new He(Fe.BOXCANCEL,this.startPixel_,null)),this.startPixel_=null)),super.setMap(e)}}class La extends Ca{constructor(e){e=e||{};const t=e.condition?e.condition:Kn;super({condition:t,className:e.className||"ol-dragzoom",minArea:e.minArea}),this.duration_=e.duration!==void 0?e.duration:200,this.out_=e.out!==void 0?e.out:!1}onBoxEnd(e){const i=this.getMap().getView();let s=this.getGeometry();if(this.out_){const r=i.rotatedExtentForGeometry(s),a=i.getResolutionForExtentInternal(r),o=i.getResolution()/a;s=s.clone(),s.scale(o*o)}i.fitInternal(s,{duration:this.duration_,easing:ot})}}const Se={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown"};class Ra extends je{constructor(e){super(),e=e||{},this.defaultCondition_=function(t){return Xn(t)&&Bn(t)},this.condition_=e.condition!==void 0?e.condition:this.defaultCondition_,this.duration_=e.duration!==void 0?e.duration:100,this.pixelDelta_=e.pixelDelta!==void 0?e.pixelDelta:128}handleEvent(e){let t=!1;if(e.type==$.KEYDOWN){const i=e.originalEvent,s=i.key;if(this.condition_(e)&&(s==Se.DOWN||s==Se.LEFT||s==Se.RIGHT||s==Se.UP)){const a=e.map.getView(),o=a.getResolution()*this.pixelDelta_;let l=0,c=0;s==Se.DOWN?c=-o:s==Se.LEFT?l=-o:s==Se.RIGHT?l=o:c=o;const d=[l,c];vn(d,a.getRotation()),fa(a,d,this.duration_),i.preventDefault(),t=!0}}return!t}}class Sa extends je{constructor(e){super(),e=e||{},this.condition_=e.condition?e.condition:function(t){return!va(t)&&Bn(t)},this.delta_=e.delta?e.delta:1,this.duration_=e.duration!==void 0?e.duration:100}handleEvent(e){let t=!1;if(e.type==$.KEYDOWN||e.type==$.KEYPRESS){const i=e.originalEvent,s=i.key;if(this.condition_(e)&&(s==="+"||s==="-")){const r=e.map,a=s==="+"?this.delta_:-this.delta_,o=r.getView();Si(o,a,void 0,this.duration_),i.preventDefault(),t=!0}}return!t}}class Aa extends je{constructor(e){e=e||{},super(e),this.totalDelta_=0,this.lastDelta_=0,this.maxDelta_=e.maxDelta!==void 0?e.maxDelta:1,this.duration_=e.duration!==void 0?e.duration:250,this.timeout_=e.timeout!==void 0?e.timeout:80,this.useAnchor_=e.useAnchor!==void 0?e.useAnchor:!0,this.constrainResolution_=e.constrainResolution!==void 0?e.constrainResolution:!1;const t=e.condition?e.condition:ya;this.condition_=e.onFocusOnly?ci(Gn,t):t,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_,this.mode_=void 0,this.trackpadEventGap_=400,this.trackpadTimeoutId_,this.deltaPerZoom_=300}endInteraction_(){this.trackpadTimeoutId_=void 0;const e=this.getMap();if(!e)return;e.getView().endInteraction(void 0,this.lastDelta_?this.lastDelta_>0?1:-1:0,this.lastAnchor_?e.getCoordinateFromPixel(this.lastAnchor_):null)}handleEvent(e){if(!this.condition_(e)||e.type!==$.WHEEL)return!0;const i=e.map,s=e.originalEvent;s.preventDefault(),this.useAnchor_&&(this.lastAnchor_=e.pixel);let r;if(e.type==$.WHEEL&&(r=s.deltaY,Ns&&s.deltaMode===WheelEvent.DOM_DELTA_PIXEL&&(r/=xn),s.deltaMode===WheelEvent.DOM_DELTA_LINE&&(r*=40)),r===0)return!1;this.lastDelta_=r;const a=Date.now();this.startTime_===void 0&&(this.startTime_=a),(!this.mode_||a-this.startTime_>this.trackpadEventGap_)&&(this.mode_=Math.abs(r)<4?"trackpad":"wheel");const o=i.getView();if(this.mode_==="trackpad"&&!(o.getConstrainResolution()||this.constrainResolution_))return this.trackpadTimeoutId_?clearTimeout(this.trackpadTimeoutId_):(o.getAnimating()&&o.cancelAnimations(),o.beginInteraction()),this.trackpadTimeoutId_=setTimeout(this.endInteraction_.bind(this),this.timeout_),o.adjustZoom(-r/this.deltaPerZoom_,this.lastAnchor_?i.getCoordinateFromPixel(this.lastAnchor_):null),this.startTime_=a,!1;this.totalDelta_+=r;const l=Math.max(this.timeout_-(a-this.startTime_),0);return clearTimeout(this.timeoutId_),this.timeoutId_=setTimeout(this.handleWheelZoom_.bind(this,i),l),!1}handleWheelZoom_(e){const t=e.getView();t.getAnimating()&&t.cancelAnimations();let i=-Ke(this.totalDelta_,-this.maxDelta_*this.deltaPerZoom_,this.maxDelta_*this.deltaPerZoom_)/this.deltaPerZoom_;(t.getConstrainResolution()||this.constrainResolution_)&&(i=i?i>0?1:-1:0),Si(t,i,this.lastAnchor_?e.getCoordinateFromPixel(this.lastAnchor_):null,this.duration_),this.mode_=void 0,this.totalDelta_=0,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_=void 0}setMouseAnchor(e){this.useAnchor_=e,e||(this.lastAnchor_=null)}}class Ia extends ct{constructor(e){e=e||{};const t=e;t.stopDown||(t.stopDown=lt),super(t),this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.threshold_=e.threshold!==void 0?e.threshold:.3,this.duration_=e.duration!==void 0?e.duration:250}handleDragEvent(e){let t=0;const i=this.targetPointers[0],s=this.targetPointers[1],r=Math.atan2(s.clientY-i.clientY,s.clientX-i.clientX);if(this.lastAngle_!==void 0){const l=r-this.lastAngle_;this.rotationDelta_+=l,!this.rotating_&&Math.abs(this.rotationDelta_)>this.threshold_&&(this.rotating_=!0),t=l}this.lastAngle_=r;const a=e.map,o=a.getView();o.getConstraints().rotation!==Tn&&(this.anchor_=a.getCoordinateFromPixelInternal(a.getEventPixel(Ai(this.targetPointers))),this.rotating_&&(a.render(),o.adjustRotationInternal(t,this.anchor_)))}handleUpEvent(e){return this.targetPointers.length<2?(e.map.getView().endInteraction(this.duration_),!1):!0}handleDownEvent(e){if(this.targetPointers.length>=2){const t=e.map;return this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.handlingDownUpSequence||t.getView().beginInteraction(),!0}return!1}}class Pa extends ct{constructor(e){e=e||{};const t=e;t.stopDown||(t.stopDown=lt),super(t),this.anchor_=null,this.duration_=e.duration!==void 0?e.duration:400,this.lastDistance_=void 0,this.lastScaleDelta_=1}handleDragEvent(e){let t=1;const i=this.targetPointers[0],s=this.targetPointers[1],r=i.clientX-s.clientX,a=i.clientY-s.clientY,o=Math.sqrt(r*r+a*a);this.lastDistance_!==void 0&&(t=this.lastDistance_/o),this.lastDistance_=o;const l=e.map,c=l.getView();t!=1&&(this.lastScaleDelta_=t),this.anchor_=l.getCoordinateFromPixelInternal(l.getEventPixel(Ai(this.targetPointers))),l.render(),c.adjustResolutionInternal(t,this.anchor_)}handleUpEvent(e){if(this.targetPointers.length<2){const i=e.map.getView(),s=this.lastScaleDelta_>1?1:-1;return i.endInteraction(this.duration_,s),!1}return!0}handleDownEvent(e){if(this.targetPointers.length>=2){const t=e.map;return this.anchor_=null,this.lastDistance_=void 0,this.lastScaleDelta_=1,this.handlingDownUpSequence||t.getView().beginInteraction(),!0}return!1}}function $n(n){n=n||{};const e=new ue,t=new ra(-.005,.05,100);return(n.altShiftDragRotate!==void 0?n.altShiftDragRotate:!0)&&e.push(new wa),(n.doubleClickZoom!==void 0?n.doubleClickZoom:!0)&&e.push(new ga({delta:n.zoomDelta,duration:n.zoomDuration})),(n.dragPan!==void 0?n.dragPan:!0)&&e.push(new xa({onFocusOnly:n.onFocusOnly,kinetic:t})),(n.pinchRotate!==void 0?n.pinchRotate:!0)&&e.push(new Ia),(n.pinchZoom!==void 0?n.pinchZoom:!0)&&e.push(new Pa({duration:n.zoomDuration})),(n.keyboard!==void 0?n.keyboard:!0)&&(e.push(new Ra),e.push(new Sa({delta:n.zoomDelta,duration:n.zoomDuration}))),(n.mouseWheelZoom!==void 0?n.mouseWheelZoom:!0)&&e.push(new Aa({onFocusOnly:n.onFocusOnly,duration:n.zoomDuration})),(n.shiftDragZoom!==void 0?n.shiftDragZoom:!0)&&e.push(new La({duration:n.zoomDuration})),e}function Wn(n){if(n instanceof mi){n.setMapInternal(null);return}n instanceof We&&n.getLayers().forEach(Wn)}function jn(n,e){if(n instanceof mi){n.setMapInternal(e);return}if(n instanceof We){const t=n.getLayers().getArray();for(let i=0,s=t.length;i<s;++i)jn(t[i],e)}}let Da=class extends pi{constructor(e){super(),e=e||{},this.on,this.once,this.un;const t=Ma(e);this.renderComplete_=!1,this.loaded_=!0,this.boundHandleBrowserEvent_=this.handleBrowserEvent.bind(this),this.maxTilesLoading_=e.maxTilesLoading!==void 0?e.maxTilesLoading:16,this.pixelRatio_=e.pixelRatio!==void 0?e.pixelRatio:xn,this.postRenderTimeoutHandle_,this.animationDelayKey_,this.animationDelay_=this.animationDelay_.bind(this),this.coordinateToPixelTransform_=ki(),this.pixelToCoordinateTransform_=ki(),this.frameIndex_=0,this.frameState_=null,this.previousExtent_=null,this.viewPropertyListenerKey_=null,this.viewChangeListenerKey_=null,this.layerGroupPropertyListenerKeys_=null,this.viewport_=document.createElement("div"),this.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),this.viewport_.style.position="relative",this.viewport_.style.overflow="hidden",this.viewport_.style.width="100%",this.viewport_.style.height="100%",this.overlayContainer_=document.createElement("div"),this.overlayContainer_.style.position="absolute",this.overlayContainer_.style.zIndex="0",this.overlayContainer_.style.width="100%",this.overlayContainer_.style.height="100%",this.overlayContainer_.style.pointerEvents="none",this.overlayContainer_.className="ol-overlaycontainer",this.viewport_.appendChild(this.overlayContainer_),this.overlayContainerStopEvent_=document.createElement("div"),this.overlayContainerStopEvent_.style.position="absolute",this.overlayContainerStopEvent_.style.zIndex="0",this.overlayContainerStopEvent_.style.width="100%",this.overlayContainerStopEvent_.style.height="100%",this.overlayContainerStopEvent_.style.pointerEvents="none",this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",this.viewport_.appendChild(this.overlayContainerStopEvent_),this.mapBrowserEventHandler_=null,this.moveTolerance_=e.moveTolerance,this.keyboardEventTarget_=t.keyboardEventTarget,this.targetChangeHandlerKeys_=null,this.targetElement_=null,this.resizeObserver_=new ResizeObserver(()=>this.updateSize()),this.controls=t.controls||zn(),this.interactions=t.interactions||$n({onFocusOnly:!0}),this.overlays_=t.overlays,this.overlayIdIndex_={},this.renderer_=null,this.postRenderFunctions_=[],this.tileQueue_=new Xr(this.getTilePriority.bind(this),this.handleTileChange_.bind(this)),this.addChangeListener(te.LAYERGROUP,this.handleLayerGroupChanged_),this.addChangeListener(te.VIEW,this.handleViewChanged_),this.addChangeListener(te.SIZE,this.handleSizeChanged_),this.addChangeListener(te.TARGET,this.handleTargetChanged_),this.setProperties(t.values);const i=this;e.view&&!(e.view instanceof we)&&e.view.then(function(s){i.setView(new we(s))}),this.controls.addEventListener(oe.ADD,s=>{s.element.setMap(this)}),this.controls.addEventListener(oe.REMOVE,s=>{s.element.setMap(null)}),this.interactions.addEventListener(oe.ADD,s=>{s.element.setMap(this)}),this.interactions.addEventListener(oe.REMOVE,s=>{s.element.setMap(null)}),this.overlays_.addEventListener(oe.ADD,s=>{this.addOverlayInternal_(s.element)}),this.overlays_.addEventListener(oe.REMOVE,s=>{const r=s.element.getId();r!==void 0&&delete this.overlayIdIndex_[r.toString()],s.element.setMap(null)}),this.controls.forEach(s=>{s.setMap(this)}),this.interactions.forEach(s=>{s.setMap(this)}),this.overlays_.forEach(this.addOverlayInternal_.bind(this))}addControl(e){this.getControls().push(e)}addInteraction(e){this.getInteractions().push(e)}addLayer(e){this.getLayerGroup().getLayers().push(e)}handleLayerAdd_(e){jn(e.layer,this)}addOverlay(e){this.getOverlays().push(e)}addOverlayInternal_(e){const t=e.getId();t!==void 0&&(this.overlayIdIndex_[t.toString()]=e),e.setMap(this)}disposeInternal(){this.controls.clear(),this.interactions.clear(),this.overlays_.clear(),this.resizeObserver_.disconnect(),this.setTarget(null),super.disposeInternal()}forEachFeatureAtPixel(e,t,i){if(!this.frameState_||!this.renderer_)return;const s=this.getCoordinateFromPixelInternal(e);i=i!==void 0?i:{};const r=i.hitTolerance!==void 0?i.hitTolerance:0,a=i.layerFilter!==void 0?i.layerFilter:Be,o=i.checkWrapped!==!1;return this.renderer_.forEachFeatureAtCoordinate(s,this.frameState_,r,o,t,null,a,null)}getFeaturesAtPixel(e,t){const i=[];return this.forEachFeatureAtPixel(e,function(s){i.push(s)},t),i}getAllLayers(){const e=[];function t(i){i.forEach(function(s){s instanceof We?t(s.getLayers()):e.push(s)})}return t(this.getLayers()),e}hasFeatureAtPixel(e,t){if(!this.frameState_||!this.renderer_)return!1;const i=this.getCoordinateFromPixelInternal(e);t=t!==void 0?t:{};const s=t.layerFilter!==void 0?t.layerFilter:Be,r=t.hitTolerance!==void 0?t.hitTolerance:0,a=t.checkWrapped!==!1;return this.renderer_.hasFeatureAtCoordinate(i,this.frameState_,r,a,s,null)}getEventCoordinate(e){return this.getCoordinateFromPixel(this.getEventPixel(e))}getEventCoordinateInternal(e){return this.getCoordinateFromPixelInternal(this.getEventPixel(e))}getEventPixel(e){const i=this.viewport_.getBoundingClientRect(),s=this.getSize(),r=i.width/s[0],a=i.height/s[1],o="changedTouches"in e?e.changedTouches[0]:e;return[(o.clientX-i.left)/r,(o.clientY-i.top)/a]}getTarget(){return this.get(te.TARGET)}getTargetElement(){return this.targetElement_}getCoordinateFromPixel(e){return Us(this.getCoordinateFromPixelInternal(e),this.getView().getProjection())}getCoordinateFromPixelInternal(e){const t=this.frameState_;return t?nt(t.pixelToCoordinateTransform,e.slice()):null}getControls(){return this.controls}getOverlays(){return this.overlays_}getOverlayById(e){const t=this.overlayIdIndex_[e.toString()];return t!==void 0?t:null}getInteractions(){return this.interactions}getLayerGroup(){return this.get(te.LAYERGROUP)}setLayers(e){const t=this.getLayerGroup();if(e instanceof ue){t.setLayers(e);return}const i=t.getLayers();i.clear(),i.extend(e)}getLayers(){return this.getLayerGroup().getLayers()}getLoadingOrNotReady(){const e=this.getLayerGroup().getLayerStatesArray();for(let t=0,i=e.length;t<i;++t){const s=e[t];if(!s.visible)continue;const r=s.layer.getRenderer();if(r&&!r.ready)return!0;const a=s.layer.getSource();if(a&&a.loading)return!0}return!1}getPixelFromCoordinate(e){const t=zs(e,this.getView().getProjection());return this.getPixelFromCoordinateInternal(t)}getPixelFromCoordinateInternal(e){const t=this.frameState_;return t?nt(t.coordinateToPixelTransform,e.slice(0,2)):null}getRenderer(){return this.renderer_}getSize(){return this.get(te.SIZE)}getView(){return this.get(te.VIEW)}getViewport(){return this.viewport_}getOverlayContainer(){return this.overlayContainer_}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOwnerDocument(){const e=this.getTargetElement();return e?e.ownerDocument:document}getTilePriority(e,t,i,s){return Kr(this.frameState_,e,t,i,s)}handleBrowserEvent(e,t){t=t||e.type;const i=new Ee(t,this,e);this.handleMapBrowserEvent(i)}handleMapBrowserEvent(e){if(!this.frameState_)return;const t=e.originalEvent,i=t.type;if(i===li.POINTERDOWN||i===$.WHEEL||i===$.KEYDOWN){const s=this.getOwnerDocument(),r=this.viewport_.getRootNode?this.viewport_.getRootNode():s,a=t.target,o=r instanceof ShadowRoot?r.host===a?r.host.ownerDocument:r:r===s?s.documentElement:r;if(this.overlayContainerStopEvent_.contains(a)||!o.contains(a))return}if(e.frameState=this.frameState_,this.dispatchEvent(e)!==!1){const s=this.getInteractions().getArray().slice();for(let r=s.length-1;r>=0;r--){const a=s[r];if(a.getMap()!==this||!a.getActive()||!this.getTargetElement())continue;if(!a.handleEvent(e)||e.propagationStopped)break}}}handlePostRender(){const e=this.frameState_,t=this.tileQueue_;if(!t.isEmpty()){let s=this.maxTilesLoading_,r=s;if(e){const a=e.viewHints;if(a[Et.ANIMATING]||a[Et.INTERACTING]){const o=Date.now()-e.time>8;s=o?0:8,r=o?0:2}}t.getTilesLoading()<s&&(t.reprioritize(),t.loadMoreTiles(s,r))}e&&this.renderer_&&!e.animate&&(this.renderComplete_?(this.hasListener(et.RENDERCOMPLETE)&&this.renderer_.dispatchRenderEvent(et.RENDERCOMPLETE,e),this.loaded_===!1&&(this.loaded_=!0,this.dispatchEvent(new ke(ve.LOADEND,this,e)))):this.loaded_===!0&&(this.loaded_=!1,this.dispatchEvent(new ke(ve.LOADSTART,this,e))));const i=this.postRenderFunctions_;if(e)for(let s=0,r=i.length;s<r;++s)i[s](this,e);i.length=0}handleSizeChanged_(){this.getView()&&!this.getView().getAnimating()&&this.getView().resolveConstraints(0),this.render()}handleTargetChanged_(){if(this.mapBrowserEventHandler_){for(let i=0,s=this.targetChangeHandlerKeys_.length;i<s;++i)ee(this.targetChangeHandlerKeys_[i]);this.targetChangeHandlerKeys_=null,this.viewport_.removeEventListener($.CONTEXTMENU,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener($.WHEEL,this.boundHandleBrowserEvent_),this.mapBrowserEventHandler_.dispose(),this.mapBrowserEventHandler_=null,this.viewport_.remove()}if(this.targetElement_){this.resizeObserver_.unobserve(this.targetElement_);const i=this.targetElement_.getRootNode();i instanceof ShadowRoot&&this.resizeObserver_.unobserve(i.host),this.setSize(void 0)}const e=this.getTarget(),t=typeof e=="string"?document.getElementById(e):e;if(this.targetElement_=t,!t)this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderTimeoutHandle_=void 0,this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0);else{t.appendChild(this.viewport_),this.renderer_||(this.renderer_=new la(this)),this.mapBrowserEventHandler_=new ca(this,this.moveTolerance_);for(const r in Y)this.mapBrowserEventHandler_.addEventListener(Y[r],this.handleMapBrowserEvent.bind(this));this.viewport_.addEventListener($.CONTEXTMENU,this.boundHandleBrowserEvent_,!1),this.viewport_.addEventListener($.WHEEL,this.boundHandleBrowserEvent_,yn?{passive:!1}:!1);let i;if(this.keyboardEventTarget_)i=this.keyboardEventTarget_;else{const r=t.getRootNode();i=r instanceof ShadowRoot?r.host:t}this.targetChangeHandlerKeys_=[H(i,$.KEYDOWN,this.handleBrowserEvent,this),H(i,$.KEYPRESS,this.handleBrowserEvent,this)];const s=t.getRootNode();s instanceof ShadowRoot&&this.resizeObserver_.observe(s.host),this.resizeObserver_.observe(t)}this.updateSize()}handleTileChange_(){this.render()}handleViewPropertyChanged_(){this.render()}handleViewChanged_(){this.viewPropertyListenerKey_&&(ee(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(ee(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);const e=this.getView();e&&(this.updateViewportSize_(this.getSize()),this.viewPropertyListenerKey_=H(e,Lt.PROPERTYCHANGE,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=H(e,$.CHANGE,this.handleViewPropertyChanged_,this),e.resolveConstraints(0)),this.render()}handleLayerGroupChanged_(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(ee),this.layerGroupPropertyListenerKeys_=null);const e=this.getLayerGroup();e&&(this.handleLayerAdd_(new Te("addlayer",e)),this.layerGroupPropertyListenerKeys_=[H(e,Lt.PROPERTYCHANGE,this.render,this),H(e,$.CHANGE,this.render,this),H(e,"addlayer",this.handleLayerAdd_,this),H(e,"removelayer",this.handleLayerRemove_,this)]),this.render()}isRendered(){return!!this.frameState_}animationDelay_(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}renderSync(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()}redrawText(){const e=this.getLayerGroup().getLayerStatesArray();for(let t=0,i=e.length;t<i;++t){const s=e[t].layer;s.hasRenderer()&&s.getRenderer().handleFontsChanged()}}render(){this.renderer_&&this.animationDelayKey_===void 0&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))}removeControl(e){return this.getControls().remove(e)}removeInteraction(e){return this.getInteractions().remove(e)}removeLayer(e){return this.getLayerGroup().getLayers().remove(e)}handleLayerRemove_(e){Wn(e.layer)}removeOverlay(e){return this.getOverlays().remove(e)}renderFrame_(e){const t=this.getSize(),i=this.getView(),s=this.frameState_;let r=null;if(t!==void 0&&Ni(t)&&i&&i.isDef()){const a=i.getHints(this.frameState_?this.frameState_.viewHints:void 0),o=i.getState();if(r={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutter:null,extent:Ui(o.center,o.resolution,o.rotation,t),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:t,tileQueue:this.tileQueue_,time:e,usedTiles:{},viewState:o,viewHints:a,wantedTiles:{},mapId:J(this),renderTargets:{}},o.nextCenter&&o.nextResolution){const l=isNaN(o.nextRotation)?o.rotation:o.nextRotation;r.nextExtent=Ui(o.nextCenter,o.nextResolution,l,t)}}this.frameState_=r,this.renderer_.renderFrame(r),r&&(r.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,r.postRenderFunctions),s&&(!this.previousExtent_||!Gs(this.previousExtent_)&&!ei(r.extent,this.previousExtent_))&&(this.dispatchEvent(new ke(ve.MOVESTART,this,s)),this.previousExtent_=qs(this.previousExtent_)),this.previousExtent_&&!r.viewHints[Et.ANIMATING]&&!r.viewHints[Et.INTERACTING]&&!ei(r.extent,this.previousExtent_)&&(this.dispatchEvent(new ke(ve.MOVEEND,this,r)),Xs(r.extent,this.previousExtent_))),this.dispatchEvent(new ke(ve.POSTRENDER,this,r)),this.renderComplete_=(this.hasListener(ve.LOADSTART)||this.hasListener(ve.LOADEND)||this.hasListener(et.RENDERCOMPLETE))&&!this.tileQueue_.getTilesLoading()&&!this.tileQueue_.getCount()&&!this.getLoadingOrNotReady(),this.postRenderTimeoutHandle_||(this.postRenderTimeoutHandle_=setTimeout(()=>{this.postRenderTimeoutHandle_=void 0,this.handlePostRender()},0))}setLayerGroup(e){const t=this.getLayerGroup();t&&this.handleLayerRemove_(new Te("removelayer",t)),this.set(te.LAYERGROUP,e)}setSize(e){this.set(te.SIZE,e)}setTarget(e){this.set(te.TARGET,e)}setView(e){if(!e||e instanceof we){this.set(te.VIEW,e);return}this.set(te.VIEW,new we);const t=this;e.then(function(i){t.setView(new we(i))})}updateSize(){const e=this.getTargetElement();let t;if(e){const s=getComputedStyle(e),r=e.offsetWidth-parseFloat(s.borderLeftWidth)-parseFloat(s.paddingLeft)-parseFloat(s.paddingRight)-parseFloat(s.borderRightWidth),a=e.offsetHeight-parseFloat(s.borderTopWidth)-parseFloat(s.paddingTop)-parseFloat(s.paddingBottom)-parseFloat(s.borderBottomWidth);!isNaN(r)&&!isNaN(a)&&(t=[Math.max(0,r),Math.max(0,a)],!Ni(t)&&(e.offsetWidth||e.offsetHeight||e.getClientRects().length)&&Ks("No map visible because the map container's width or height are 0."))}const i=this.getSize();t&&(!i||!pn(t,i))&&(this.setSize(t),this.updateViewportSize_(t))}updateViewportSize_(e){const t=this.getView();t&&t.setViewportSize(e)}};function Ma(n){let e=null;n.keyboardEventTarget!==void 0&&(e=typeof n.keyboardEventTarget=="string"?document.getElementById(n.keyboardEventTarget):n.keyboardEventTarget);const t={},i=n.layers&&typeof n.layers.getLayers=="function"?n.layers:new We({layers:n.layers});t[te.LAYERGROUP]=i,t[te.TARGET]=n.target,t[te.VIEW]=n.view instanceof we?n.view:new we;let s;n.controls!==void 0&&(Array.isArray(n.controls)?s=new ue(n.controls.slice()):(ie(typeof n.controls.getArray=="function","Expected `controls` to be an array or an `ol/Collection.js`"),s=n.controls));let r;n.interactions!==void 0&&(Array.isArray(n.interactions)?r=new ue(n.interactions.slice()):(ie(typeof n.interactions.getArray=="function","Expected `interactions` to be an array or an `ol/Collection.js`"),r=n.interactions));let a;return n.overlays!==void 0?Array.isArray(n.overlays)?a=new ue(n.overlays.slice()):(ie(typeof n.overlays.getArray=="function","Expected `overlays` to be an array or an `ol/Collection.js`"),a=n.overlays):a=new ue,{controls:s,interactions:r,keyboardEventTarget:e,overlays:a,values:t}}const Zt="units",Fa=[1,2,5],Ve=25.4/.28;class Oa extends Nt{constructor(e){e=e||{};const t=document.createElement("div");t.style.pointerEvents="none",super({element:t,render:e.render,target:e.target}),this.on,this.once,this.un;const i=e.className!==void 0?e.className:e.bar?"ol-scale-bar":"ol-scale-line";this.innerElement_=document.createElement("div"),this.innerElement_.className=i+"-inner",this.element.className=i+" "+at,this.element.appendChild(this.innerElement_),this.viewState_=null,this.minWidth_=e.minWidth!==void 0?e.minWidth:64,this.maxWidth_=e.maxWidth,this.renderedVisible_=!1,this.renderedWidth_=void 0,this.renderedHTML_="",this.addChangeListener(Zt,this.handleUnitsChanged_),this.setUnits(e.units||"metric"),this.scaleBar_=e.bar||!1,this.scaleBarSteps_=e.steps||4,this.scaleBarText_=e.text||!1,this.dpi_=e.dpi||void 0}getUnits(){return this.get(Zt)}handleUnitsChanged_(){this.updateElement_()}setUnits(e){this.set(Zt,e)}setDpi(e){this.dpi_=e}updateElement_(){const e=this.viewState_;if(!e){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const t=e.center,i=e.projection,s=this.getUnits(),r=s=="degrees"?"degrees":"m";let a=st(i,e.resolution,t,r);const o=this.minWidth_*(this.dpi_||Ve)/Ve,l=this.maxWidth_!==void 0?this.maxWidth_*(this.dpi_||Ve)/Ve:void 0;let c=o*a,d="";if(s=="degrees"){const L=fn.degrees;c*=L,c<L/60?(d="″",a*=3600):c<L?(d="′",a*=60):d="°"}else if(s=="imperial")c<.9144?(d="in",a/=.0254):c<1609.344?(d="ft",a/=.3048):(d="mi",a/=1609.344);else if(s=="nautical")a/=1852,d="NM";else if(s=="metric")c<1e-6?(d="nm",a*=1e9):c<.001?(d="μm",a*=1e6):c<1?(d="mm",a*=1e3):c<1e3?d="m":(d="km",a/=1e3);else if(s=="us")c<.9144?(d="in",a*=39.37):c<1609.344?(d="ft",a/=.30480061):(d="mi",a/=1609.3472);else throw new Error("Invalid units");let u=3*Math.floor(Math.log(o*a)/Math.log(10)),f,y,h,_,T,w;for(;;){h=Math.floor(u/3);const L=Math.pow(10,h);if(f=Fa[(u%3+3)%3]*L,y=Math.round(f/a),isNaN(y)){this.element.style.display="none",this.renderedVisible_=!1;return}if(l!==void 0&&y>=l){f=_,y=T,h=w;break}else if(y>=o)break;_=f,T=y,w=h,++u}const p=this.scaleBar_?this.createScaleBar(y,f,d):f.toFixed(h<0?-h:0)+" "+d;this.renderedHTML_!=p&&(this.innerElement_.innerHTML=p,this.renderedHTML_=p),this.renderedWidth_!=y&&(this.innerElement_.style.width=y+"px",this.renderedWidth_=y),this.renderedVisible_||(this.element.style.display="",this.renderedVisible_=!0)}createScaleBar(e,t,i){const s=this.getScaleForResolution(),r=s<1?Math.round(1/s).toLocaleString()+" : 1":"1 : "+Math.round(s).toLocaleString(),a=this.scaleBarSteps_,o=e/a,l=[this.createMarker("absolute")];for(let d=0;d<a;++d){const u=d%2===0?"ol-scale-singlebar-odd":"ol-scale-singlebar-even";l.push(`<div><div class="ol-scale-singlebar ${u}" style="width: ${o}px;"></div>`+this.createMarker("relative")+(d%2===0||a===2?this.createStepText(d,e,!1,t,i):"")+"</div>")}return l.push(this.createStepText(a,e,!0,t,i)),(this.scaleBarText_?`<div class="ol-scale-text" style="width: ${e}px;">`+r+"</div>":"")+l.join("")}createMarker(e){return`<div class="ol-scale-step-marker" style="position: ${e}; top: ${e==="absolute"?3:-10}px;"></div>`}createStepText(e,t,i,s,r){const o=(e===0?0:Math.round(s/this.scaleBarSteps_*e*100)/100)+(e===0?"":" "+r),l=e===0?-3:t/this.scaleBarSteps_*-1,c=e===0?0:t/this.scaleBarSteps_*2;return`<div class="ol-scale-step-text" style="margin-left: ${l}px;text-align: ${e===0?"left":"center"};min-width: ${c}px;left: ${i?t+"px":"unset"};">`+o+"</div>"}getScaleForResolution(){const e=st(this.viewState_.projection,this.viewState_.resolution,this.viewState_.center,"m"),t=this.dpi_||Ve,i=1e3/25.4;return e*i*t}render(e){const t=e.frameState;t?this.viewState_=t.viewState:this.viewState_=null,this.updateElement_()}}const ka={SELECT:"select"};class Na extends rt{constructor(e,t,i,s){super(e),this.selected=t,this.deselected=i,this.mapBrowserEvent=s}}const xt={};class Ii extends je{constructor(e){super(),this.on,this.once,this.un,e=e||{},this.boundAddFeature_=this.addFeature_.bind(this),this.boundRemoveFeature_=this.removeFeature_.bind(this),this.condition_=e.condition?e.condition:Ea,this.addCondition_=e.addCondition?e.addCondition:Vi,this.removeCondition_=e.removeCondition?e.removeCondition:Vi,this.toggleCondition_=e.toggleCondition?e.toggleCondition:Kn,this.multi_=e.multi?e.multi:!1,this.filter_=e.filter?e.filter:Be,this.hitTolerance_=e.hitTolerance?e.hitTolerance:0,this.style_=e.style!==void 0?e.style:Ua(),this.features_=e.features||new ue;let t;if(e.layers)if(typeof e.layers=="function")t=e.layers;else{const i=e.layers;t=function(s){return i.includes(s)}}else t=Be;this.layerFilter_=t,this.featureLayerAssociation_={}}addFeatureLayerAssociation_(e,t){this.featureLayerAssociation_[J(e)]=t}getFeatures(){return this.features_}getHitTolerance(){return this.hitTolerance_}getLayer(e){return this.featureLayerAssociation_[J(e)]}setHitTolerance(e){this.hitTolerance_=e}setMap(e){this.getMap()&&this.style_&&this.features_.forEach(this.restorePreviousStyle_.bind(this)),super.setMap(e),e?(this.features_.addEventListener(oe.ADD,this.boundAddFeature_),this.features_.addEventListener(oe.REMOVE,this.boundRemoveFeature_),this.style_&&this.features_.forEach(this.applySelectedStyle_.bind(this))):(this.features_.removeEventListener(oe.ADD,this.boundAddFeature_),this.features_.removeEventListener(oe.REMOVE,this.boundRemoveFeature_))}addFeature_(e){const t=e.element;if(this.style_&&this.applySelectedStyle_(t),!this.getLayer(t)){const i=this.getMap().getAllLayers().find(function(s){if(s instanceof pe&&s.getSource()&&s.getSource().hasFeature(t))return s});i&&this.addFeatureLayerAssociation_(t,i)}}removeFeature_(e){this.style_&&this.restorePreviousStyle_(e.element)}getStyle(){return this.style_}applySelectedStyle_(e){const t=J(e);t in xt||(xt[t]=e.getStyle()),e.setStyle(this.style_)}restorePreviousStyle_(e){const t=this.getMap().getInteractions().getArray();for(let s=t.length-1;s>=0;--s){const r=t[s];if(r!==this&&r instanceof Ii&&r.getStyle()&&r.getFeatures().getArray().lastIndexOf(e)!==-1){e.setStyle(r.getStyle());return}}const i=J(e);e.setStyle(xt[i]),delete xt[i]}removeFeatureLayerAssociation_(e){delete this.featureLayerAssociation_[J(e)]}handleEvent(e){if(!this.condition_(e))return!0;const t=this.addCondition_(e),i=this.removeCondition_(e),s=this.toggleCondition_(e),r=!t&&!i&&!s,a=e.map,o=this.getFeatures(),l=[],c=[];if(r){yi(this.featureLayerAssociation_),a.forEachFeatureAtPixel(e.pixel,(d,u)=>{if(!(!(d instanceof tt)||!this.filter_(d,u)))return this.addFeatureLayerAssociation_(d,u),c.push(d),!this.multi_},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_});for(let d=o.getLength()-1;d>=0;--d){const u=o.item(d),f=c.indexOf(u);f>-1?c.splice(f,1):(o.remove(u),l.push(u))}c.length!==0&&o.extend(c)}else{a.forEachFeatureAtPixel(e.pixel,(d,u)=>{if(!(!(d instanceof tt)||!this.filter_(d,u)))return(t||s)&&!o.getArray().includes(d)?(this.addFeatureLayerAssociation_(d,u),c.push(d)):(i||s)&&o.getArray().includes(d)&&(l.push(d),this.removeFeatureLayerAssociation_(d)),!this.multi_},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_});for(let d=l.length-1;d>=0;--d)o.remove(l[d]);o.extend(c)}return(c.length>0||l.length>0)&&this.dispatchEvent(new Na(ka.SELECT,c,l,e)),!0}}function Ua(){const n=Bs();return zi(n.Polygon,n.LineString),zi(n.GeometryCollection,n.LineString),function(e){return e.getGeometry()?n[e.getGeometry().getType()]:null}}async function za(n,e,t){let i=document.querySelector(".progress-bar");if(!i){i=document.createElement("div"),i.classList.add("progress-bar"),i.style.position="relative",i.style.width="100%",i.style.backgroundColor="#fff",i.style.borderRadius="4px",i.style.height="10px";const o=document.createElement("div");o.classList.add("progress-fill"),o.style.width="0%",o.style.height="10px",o.style.borderRadius="4px",o.style.backgroundColor="#249702",i.appendChild(o),document.querySelector("#modal-content").appendChild(i)}const s=i.querySelector(".progress-fill");let r=0;e=e*10;const a=setInterval(async()=>{r++;const o=r/e*100;if(s.style.width=`${o}%`,r>=e){clearInterval(a),s.style.width="100%",console.log("Действие завершено!");const l=await S("/resource",{action:"check_mine",resource_id:n});if(l.reward&&l.reward.length>0){let c="Вы получили:<br>";l.reward.forEach(d=>{c+=`${d.name} x${d.quantity}<br>`}),C.setSelfInfo(await S("/player",{action:"get_self"})),U.createToast(c),j.closeModalHandler(t)}}},100)}let bt,Ae,Ne;function he(n){const e=document.createElement("p");e.innerHTML=n,bt.appendChild(e),bt.scrollTop=bt.scrollHeight}async function Ga(n){await S("/monster",{action:"get",monster_id:n}).then(e=>{Ne=e,e&&(j.showModal(e.name,`
                        <p>${e.description}</p>
                        <div style="text-align: center;">Здоровье <span id="health-monster">${Ne.health}</span> / ${Ne.max_health}</div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${Ne.health*100/Ne.max_health+"%"}" id="health-monster-progress"></div></div>
                        <button class="monsters-fight">Напасть</button>
                        <div class="battle-log"></div>
                        <button class="monsters-attack" style="display: none">Ударить</button>
                    `),bt=document.querySelector(".battle-log"),Ae=document.querySelector(".monsters-attack"),Ae.onclick=async t=>{await Zi(n,t)})}),document.querySelector(".monsters-fight")&&(document.querySelector(".monsters-fight").onclick=async e=>{e.preventDefault(),e.target.disabled=!0,await S("/monster",{action:"fight_start",monster_id:n}).then(async t=>{t&&t.fight===!0&&await Zi(n,e)}).catch(t=>{console.error("Не удалось начать бой: "+t),U.createToast("Не удалось начать бой. Попробуйте снова."),e.target.disabled=!1,e.target.style.display="block"})})}async function Zi(n,e){Ae.setAttribute("disabled","disabled"),await S("/monster",{action:"monster_attack",monster_id:n}).then(async t=>{t&&(e.target.style.display="none",Ae.style.display="block",t.status==="fight"?(he(`Вы нанесли врагу ${t.damage_to_monster} урона.${t.damage_to_monster===0?" Враг уклонился.":""}`),he(`Враг нанес вам ${t.damage_to_player} урона.${t.damage_to_player===0?" Вы уклонились.":""}`)):t.status==="victory"?(he(`Вы нанесли врагу ${t.damage_to_monster} урона.`),he("<b>Враг побежден!</b>"),he("<b>Ваши награды:</b>"),t.reward.silver&&he(`Серебро: ${t.reward.silver}`),t.reward.items.length>0&&t.reward.items.forEach(i=>{he(`${i.name}`)}),Ae.style.display="none"):t.status==="defeat"&&(he(`Вы нанесли врагу ${t.damage_to_monster} урона.${t.damage_to_monster===0?" Враг уклонился.":""}`),he(`Враг нанес вам ${t.damage_to_player} урона.`),he("Вы проиграли!"),Ae.style.display="none"),C.setSelfInfo(await S("/player",{action:"get_self"})),U.updateStatusBar(C.getSelfInfo()),document.querySelector("#health-monster").textContent=t.new_health_monster,document.querySelector("#health-monster-progress").style.width=""+t.new_health_monster*100/Ne.max_health+"%",Ae.removeAttribute("disabled"))})}function qa(n){return`
        <div class="crafting-window">
            <div class="crafting-buttons">
                <button class="craft-button active" data-item-type='resource'>Ресурсы</button>
                <button class="craft-button" data-item-type='weapon'>Оружие</button>
                <button class="craft-button" data-item-type='armor'>Броня</button>
                <button class="craft-button" data-item-type='tool'>Инструменты</button>
            </div>

            <div class="recipe-list">
                ${Xa(n)}
            </div>
        </div>
    `}function Xa(n){let e="",t="";return n&&Object.keys(n).length>0?(n.forEach(i=>{var r;t="";let s=!1;i.materials_required.forEach(a=>{t+=`${a.count} ${a.resource.name}<br>`}),(r=C.getSelfInfo())==null||r.skill_progress.forEach(a=>{(i.item.type===a.type_item&&i.item.resource_type===a.type_resource&&i.item.tier>a.current_level||i.item.type==="resource"&&a.type_item==="craft"&&i.item.resource_type===a.type_resource&&i.item.tier>a.current_level)&&(s=!0)}),e+=`
                <div class="recipe-item" style="display: ${i.item.type==="resource"?"flex":"none"}" data-item-type="${i.item.type}">
                    ${U.drawItem(i.item)}
                    <div class="recipe-info">
                        <h3>${i.item.name}</h3>
                        <p>${t}</p>
                    </div>
                    <button class="craft-btn" ${s?"disabled":""} data-craft-run="${i.id}">Изготовить</button>
                </div>
            `}),e):"Рецепты отсутствуют"}async function Ka(n,e,t){let i=document.querySelector(".progress-bar");if(!i){i=document.createElement("div"),i.classList.add("progress-bar"),i.style.position="relative",i.style.width="100%",i.style.backgroundColor="#fff",i.style.borderRadius="4px",i.style.height="10px";const o=document.createElement("div");o.classList.add("progress-fill"),o.style.width="0%",o.style.height="10px",o.style.borderRadius="4px",o.style.backgroundColor="#249702",i.appendChild(o),document.querySelector("#modal-content").appendChild(i)}const s=i.querySelector(".progress-fill");let r=0;e=e*10;const a=setInterval(async()=>{r++;const o=r/e*100;s.style.width=`${o}%`,r>=e&&(clearInterval(a),s.style.width="100%",t.target.disabled=!1,await S("/recipe",{action:"get_make_result",recipe_id:n}).then(async l=>{C.setSelfInfo(await S("/player",{action:"get_self"}))}))},100)}const Qi={drawCraftingWindow:qa,animatedCraft:Ka};function Ba(){const n=C.getSelfInfo().profile;return`
        <form id="profile-form">
          <div class="profile-row">
            <div class="profile-avatar">
                <label for="avatar">Аватар:</label>
                <img id="current-avatar" data-avatar-id="${n.avatar_id}" src="${n.avatar}" alt="">
                <button type="button" id="change-avatar-btn">Изменить</button>
            </div>
          </div>
          <div class="avatar-selection" id="avatar-selection" style="display: none;"></div>
          <div class="profile-row">
            <div>
              <label for="username">Имя:</label>
              <input type="text" name="name" placeholder="Иван" value="${n.name}">
            </div>
            <div>
              <label for="birthday">Дата рождения:</label>
              <input type="date" name="birthday" value="${n.birthday}">
            </div>
          </div>
          <label for="description">Немного о себе:</label>
          <textarea name="bio" placeholder="Расскажите немного о себе. Как часто вы играете, какой тип игры предпочитаете...">${n.bio}</textarea>

          <div class="buttons">
            <button type="button" id="save-btn">Сохранить</button>
          </div>
        </form>
    `}function $a(){document.querySelector("#save-btn").addEventListener("click",async function(i){i.preventDefault();const s=document.querySelector('input[name="name"]').value,r=document.querySelector('textarea[name="bio"]').value,a=document.querySelector('input[name="birthday"]').value,o=document.querySelector("#current-avatar").getAttribute("data-avatar-id");return await S("/profile",{action:"save",name:s,bio:r,birthday:a,avatar_id:o}).then(async l=>{l&&l.saved===!0&&(j.closeModalHandler(i),C.setSelfInfo(await S("/player",{action:"get_self"})),U.updateStatusBar(C.getSelfInfo()),console.log(C.getSelfInfo()))}),!1});const n=document.querySelector("#change-avatar-btn"),e=document.querySelector("#avatar-selection"),t=document.querySelector("#current-avatar");return n.addEventListener("click",async function(){await S("/avatar",{action:"get"}).then(async i=>{let s="";i&&i.length>0&&i.forEach(r=>{s+=`<img src="${r.url}" data-avatar-id="${r.id}" class="avatar-option" data-avatar="${r.url}" alt="${r.title}">`}),e.innerHTML=s,document.querySelectorAll(".avatar-option").forEach(function(r){r.addEventListener("click",function(){t.src=r.getAttribute("data-avatar"),t.setAttribute("data-avatar-id",r.getAttribute("data-avatar-id")),e.style.display="none"})})}),e.style.display=e.style.display==="none"?"flex":"none"}),!0}const Ji={drawProfileWindow:Ba,events:$a};function Wa(n){return`
        <form id="settings-form">
          <div class="form-group" style="display: none">
            <label>
              <input type="checkbox" name="display_active" ${n.display_active?"checked":""}>
              Не гасить экран
            </label>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" name="notifications" ${n.notifications?"checked":""}>
              Уведомления в игре
            </label>
          </div>
          <div class="buttons">
            <button type="submit" id="save-settings-btn">Сохранить</button>
          </div>
        </form>
    `}function ja(){return document.querySelector("#settings-form").addEventListener("submit",async function(n){n.preventDefault();let e={display_active:document.querySelector('input[name="display_active"]').checked?1:0,notifications:document.querySelector('input[name="notifications"]').checked?1:0};return await S("/settings",{action:"save",settings:JSON.stringify(e)}).then(async t=>{if(t&&t.saved===!0){C.setSelfInfo(await S("/player",{action:"get_self"})),await Yn(C.getSelfInfo().settings);const i=await navigator.serviceWorker.ready;if(e.notifications){const s=await i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Ya(C.publicVapidKey)});await S("/webpush",{action:"subscribe",subscription:JSON.stringify(s)}).then(()=>{console.log("Подписка отправлена на сервер.")})}else if("serviceWorker"in navigator){const s=await i.pushManager.getSubscription();console.log(s),s&&(await s.unsubscribe(),await S("/webpush",{action:"unsubscribe",subscription_endpoint:s.endpoint}).then(async()=>{console.log("Подписка на уведомления удалена.")}))}}}),!1}),!0}let en=null;async function Yn(n){if(n&&n.display_active&&n.display_active===1)try{en=await navigator.wakeLock.request("screen"),console.log("Wake Lock активирован"),en.addEventListener("release",()=>{console.log("Wake Lock деактивирован")})}catch(e){console.error("Ошибка активации Wake Lock:",e)}}function Ya(n){const e="=".repeat((4-n.length%4)%4),t=(n+e).replace(/-/g,"+").replace(/_/g,"/"),i=window.atob(t);return Uint8Array.from([...i].map(s=>s.charCodeAt(0)))}const Qt={drawSettingsWindow:Wa,events:ja,applySettings:Yn};function Ha(){return`
        <form id="feedback-form">
          <label for="title">Тема:</label>
          <input type="text" name="title">
          <label for="description">Описание:</label>
          <textarea name="description" placeholder="Опишите вашу проблему или предложение..."></textarea>
          <div class="buttons">
            <button type="submit" id="save-btn">Отправить</button>
          </div>
        </form>
    `}function Va(){return document.querySelector("#feedback-form").addEventListener("submit",async function(n){n.preventDefault();const e=document.querySelector('input[name="title"]').value,t=document.querySelector('textarea[name="description"]').value;if(!e||!t||!t.trim().length){U.createToast("Все поля обязательны для заполнения");return}return await S("/feedback",{action:"save",title:e,description:t}).then(i=>{i&&i.saved===!0&&j.closeModalHandler(n)}),!1}),!0}const tn={drawFeedbackWindow:Ha,events:Va};async function Za(n){let e="";return await S("/player",{action:"get_player_info",player_id:n}).then(t=>{e=`
            <div class="player-info">
                <div class="top-section">
                    <div class="avatar">
                        <img src="${t.avatar}" alt="">
                    </div>
                    <div class="details">
                        ${t.username}
                        <br>
                        <b>Дата регистрации:</b> ${t.register}
                    </div>
                </div>
                <div class="info">
                    ${t.name?"<b>Имя:</b> "+t.name:""}<br>
                    ${t.birthday?"<b>Дата рождения:</b> "+t.birthday:""}<br>
                    ${t.bio?"<b>Немного о себе:</b> "+t.bio:""}<br>
                </div>
            </div>
        `}),e}const Qa={drawPlayerWindow:Za},se=1,re=0,ae="";function Ja(n){const e={armor:{skin:{level:se,percent:re,exp:ae},ore:{level:se,percent:re,exp:ae},cloth:{level:se,percent:re,exp:ae}},weapon:{ore:{level:se,percent:re,exp:ae},wood:{level:se,percent:re,exp:ae}},tool:{wood:{level:se,percent:re,exp:ae},ore:{level:se,percent:re,exp:ae},skin:{level:se,percent:re,exp:ae}},craft:{wood:{level:se,percent:re,exp:ae},ore:{level:se,percent:re,exp:ae},skin:{level:se,percent:re,exp:ae},cloth:{level:se,percent:re,exp:ae}}};n==null||n.forEach(i=>{var a;const s=i.type_item,r=i.type_resource;(a=e[s])!=null&&a[r]&&(e[s][r]={level:i.current_level,percent:i.current_experience*100/i.experience_required,exp:`${i.current_experience}/${i.experience_required}`})});const t=(i,s,r)=>`
        <div class="item-progress">
            <div class="item-name">${s} Ур. ${i.level}</div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${i.percent}%;"></div>
                    <div class="progress-caption">${i.percent>0?i.exp:""}</div>
                </div>
            </div>
        </div>
    `;return`
        <div class="skill-window">
            <div class="item-category">
                <h2>Броня</h2>
                ${t(e.armor.skin,"Кожа")}
                ${t(e.armor.ore,"Латы")}
                ${t(e.armor.cloth,"Ткань")}
            </div>
            
            <div class="item-category">
                <h2>Оружие</h2>
                ${t(e.weapon.ore,"Меч")}
                ${t(e.weapon.wood,"Лук")}
            </div>
            
            <div class="item-category">
                <h2>Инструменты</h2>
                ${t(e.tool.wood,"Топор")}
                ${t(e.tool.ore,"Кирка")}
                ${t(e.tool.skin,"Нож")}
            </div>
            
            <div class="item-category">
                <h2>Крафт</h2>
                ${t(e.craft.wood,"Дерево")}
                ${t(e.craft.ore,"Металл/Камень")}
                ${t(e.craft.skin,"Кожа")}
                ${t(e.craft.cloth,"Ткань")}
            </div>
        </div>
    `}const eo={drawProgressWindow:Ja};function to(n){if(n&&n.length){const e=document.querySelector(".notification-badge");e.innerText=n.length,e.style.display="block"}}function io(n,e="view"){let t="",i="",s="",r="",a="",o="";if(n&&n.length){let l=1;n.forEach(c=>{i="",s="",r="",a="",o="",Object.keys(c.reward).length>0&&(c.reward.items&&c.reward.items.forEach(d=>{s+=U.drawItem(d)}),c.reward.money&&c.reward.money.silver>0&&(o=`
                            <div class="reward-stats">
                            <div class="reward-money">
                              <span class="silver-amount" title="Серебро">${c.reward.money.silver}</span>
                            </div>
                          </div>
                        `),i+=`
                        <div class="quest-rewards">
                          <b>Награда</b>
                          <div class="reward-items">
                            ${s}
                          </div>
                          ${o}
                        </div>
                    `),c.conditions&&(s="",c.conditions.forEach(d=>{s+=`
                            <div>${d.action}: ${d.target_name?d.target_name+" - ":""}  ${d.current?d.current:0}/${d.quantity}</div>
                        `}),s.length>0&&(r+=`
                            <div class="quest-conditions">
                              <b>Цели</b>
                              <div class="condition-items">
                                ${s}
                              </div>
                            </div>
                        `)),e==="accept"?a=`<button class="button-access" data-quest-id="${c.id}">Принять квест</button>`:e==="view"&&c.completed&&(a=`<button class="complete-quest-button" data-quest-id="${c.id}">Завершить</button>`),t+=`
                    <div class="row" data-row-questId="${c.id}" onclick="return false;">
                        <div class="collapsible-header" data-open-content><b>${l}. ${c.name}</b></div>
                        <div class="collapsible-content">
                            <p>${c.description}</p>
                            ${r}
                            ${i}
                            ${a}
                        </div>
                    </div>
                `,l++})}else t='<div class="quest-empty">Тут пока пусто</div>';return`<div class="quest-list">${t}</div>`}const Oe={generateQuestWindow:io,updateCountQuest:to};async function no(n){await S("/portal",{action:"get_portal",portal_id:n}).then(e=>{e&&(j.showModal(e==null?void 0:e.name,`
                        <p>${e==null?void 0:e.description}</p>
                        <p>Для закрытия этого разлома необходимо <b>${e.energy_required} Энергии Арвенты</b>, но сперва нужно будет <b>ввести верный код</b>. Приготовьтесь.</p>
                        <button class="portal-close">Закрыть разлом</button>
                    `),document.querySelector(".portal-close")&&(document.querySelector(".portal-close").onclick=async t=>{t.preventDefault(),t.target.disabled=!0,j.showModal(e==null?void 0:e.name,`
                        <div class="portal-window">
                            <div id="instruction">
                                Запомните последовательность символов, которая появится на секунду.<br>
                                Затем повторите её, нажимая на символы из набора за 10 секунд.
                            </div>
                            <div id="selectedContainer"></div>
                            <div id="glyphContainer" style="display: none;"></div>
                            <div id="buttons">
                                <button id="resetButton">Сбросить</button>
                            </div>
                            <div id="timer"></div>
                            <div id="message"></div>
                            <div id="overlay" style="display: none;"></div>
                          </div>
                    `),await Vn(n)}))})}let Dt="",nn=[],Hn=null,ze="",Mt=null;const so=10;let sn,Ze,Ft,rn,$e,Ge,Qe;function ro(){let n=so;Ge.textContent=`Осталось времени: ${n} с`,Mt=setInterval(()=>{n--,Ge.textContent=`Осталось времени: ${n} с`,n<=0&&(clearInterval(Mt),Ge.textContent="Время истекло!",$e.textContent="Время вышло! Разлом остаётся открытым.",setTimeout(Zn,1500))},1e3)}async function Vn(n){sn=document.getElementById("instruction"),Ze=document.getElementById("glyphContainer"),Ft=document.getElementById("selectedContainer"),rn=document.getElementById("resetButton"),$e=document.getElementById("message"),Ge=document.getElementById("timer"),Qe=document.getElementById("overlay"),rn.addEventListener("click",Zn),await S("/portal",{action:"get_puzzle",portal_id:n}).then(e=>{Hn=e.puzzle_id,Dt=e.sequence,nn=e.options,Qe.style.display="flex",Qe.textContent=Dt,Ze.style.display="none",ze="",Ft.innerHTML="",$e.textContent="",Ge.textContent="",setTimeout(()=>{Qe.style.display="none",Qe.textContent="",Ze.style.display="flex",Ze.innerHTML="",nn.slice().sort(()=>Math.random()-.5).forEach(i=>{const s=document.createElement("div");s.classList.add("glyph"),s.textContent=i,s.addEventListener("click",()=>ao(i)),Ze.appendChild(s)}),ro()},1e3)}).catch(e=>{sn.textContent="Не удалось загрузить пазл.",console.error(e)})}function ao(n){if(ze.length<Dt.length){ze+=n;const e=document.createElement("div");e.classList.add("glyph"),e.textContent=n,Ft.appendChild(e),ze.length===Dt.length&&setTimeout(oo,300)}}function Zn(){ze="",Ft.innerHTML="",$e.textContent="",clearInterval(Mt),Ge.textContent="",Vn().then(n=>{})}async function oo(){clearInterval(Mt),$e.textContent="Проверка...",await S("/portal",{action:"check_puzzle",puzzle_id:Hn,selected_sequence:ze}).then(async n=>{(n==null?void 0:n.closed)===!0&&C.setSelfInfo(await S("/player",{action:"get_self"}))}).catch(n=>{$e.textContent="Ошибка связи с сервером.",console.error(n)}).finally(()=>{j.closeModalHandler()})}async function lo(){let n="";return await S("/portal",{action:"get_stats"}).then(e=>{e&&(e==null||e.forEach(t=>{n+=`
                    <tr>
                      <td>${t.position}</td>
                      <td>${t.username}</td>
                      <td>${t.total_attempts}</td>
                      <td>${t.total_points}</td>
                      <td>${t.avg_closure_time}</td>
                      <td>${t.total_energy_used}</td>
                    </tr>
                `}))}),`
        <div class="table-container rpg-border">
        <table class="statistics-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Игрок</th>
              <th>Разломов закрыто</th>
              <th>Очки</th>
              <th>Ср. время</th>
              <th>Энергия потрачена</th>
            </tr>
          </thead>
          <tbody>
            ${n}
          </tbody>
        </table>
      </div>
    `}const co={getStats:lo};function ho(n){const e=`
    <div id="createLotModal" class="create-lot-modal">
      <!-- Верхняя часть: компактная форма создания лота -->
      <div class="lot-creation-section">
        <div id="selectedItemContainer" class="selected-item">
          <!-- Изначально показывается сообщение с просьбой выбрать предмет -->
          <p class="placeholder">Выберите предмет из инвентаря</p>
        </div>
        <div class="lot-form-inline">
          <input type="number" id="lotPrice" name="lotPrice" placeholder="Цена" required min="1" />
          <input type="number" id="lotQuantity" name="lotQuantity" placeholder="Кол-во" required min="1" value="1" />
          <button id="createLotBtn" class="modal-confirm">Выставить</button>
        </div>
      </div>
      <!-- Нижняя часть: сетка предметов инвентаря -->
      <div class="inventory-grid">
          ${n.filter(t=>!t.is_equipped).map(t=>U.drawItem(t)).join("")}
      </div>
    </div>
    `;j.showModal("Создание лота",e,()=>{document.querySelectorAll("[data-item-id]").forEach(t=>{t.addEventListener("click",function(i){i.preventDefault(),i.stopPropagation();const s=parseInt(this.getAttribute("data-item-id")),r=n.find(a=>a.item_id===s);if(r){const a=document.getElementById("selectedItemContainer");a.innerHTML=U.drawItem(r),a.setAttribute("data-selected-item-id",r.user_item_id)}return!1})}),document.getElementById("createLotBtn").addEventListener("click",async function(){const i=document.getElementById("selectedItemContainer").getAttribute("data-selected-item-id");if(!i){U.createToast("Пожалуйста, выберите предмет из инвентаря для продажи.");return}const s=parseInt(document.getElementById("lotPrice").value),r=parseInt(document.getElementById("lotQuantity").value,10);if(!s||s<=0||!r||r<=0){U.createToast("Пожалуйста, введите корректные данные для цены и количества.");return}await S("/market",{action:"create_lot",item_id:i,price:s,quantity:r}).then(a=>{console.log(a),a!=null&&a.created&&(a==null?void 0:a.created)===!0&&j.closeModalHandler()}).catch(a=>{console.log(a)})})})}function Qn(n){const e=new Date,i=new Date(n)-e;if(i<=0)return"Истёк";const s=Math.floor(i/(1e3*60*60*24)),r=Math.floor(i%(1e3*60*60*24)/(1e3*60*60)),a=Math.floor(i%(1e3*60*60)/(1e3*60));let o="";return s>0&&(o+=`${s} дн. `),r>0&&(o+=`${r} ч. `),a>0&&(o+=`${a} мин.`),o.trim()}async function Jn(){return await S("/market",{action:"get_lots"}).then(n=>n).catch(n=>(console.log(n),null))}async function uo(){let n="";const e=await Jn();e&&e.length>0&&e.forEach(t=>{const i=Qn(t.expires_at);n+=`
                <div class="item-row" data-name="${t.item_data.name}" data-level="${t.item_data.tier}" data-type="${t.item_data.type}">
                    ${U.drawItem(t.item_data)}
                    <div class="item-details">
                      <span><strong>${t.item_data.name}</strong></span>
                      <span>Ур.: ${t.item_data.tier} | Тип: ${t.item_data.item_type}</span>
                      <div class="silver" title="Серебро">${t.price}</div>
                    </div>
                    <div class="item-details">
                      <span class="expires" data-expires-at="${t.expires_at}" title="Время до окончания лота">${i}</span>
                    </div>
                    <div class="item-actions">
                      <button class="buy-btn" data-lot-id="${t.id}">Купить</button>
                    </div>
                </div>
            `}),j.showModal("Рынок",`
        <div class="container-market">
            <!-- Компактная панель фильтра -->
            <div class="filter-panel">
              <div class="filter-header" id="filterToggle">
                <h2>Фильтр товаров</h2>
                <span id="toggleIcon">&#9660;</span> <!-- Стрелка вниз -->
              </div>
              <div class="filter-content" id="filterContent">
                <input type="text" id="filterName" placeholder="Название предмета">
                <input type="number" id="filterLevel" placeholder="Уровень">
                <select id="filterType">
                  <option value="">Все типы</option>
                  <option value="weapon">Оружие</option>
                  <option value="armor">Броня</option>
                  <option value="tool">Инструменты</option>
                  <option value="resource">Ресурсы</option>
                </select>
                <button id="filterBtn">Применить фильтр</button>
              </div>
            </div>
            <div class="item-actions">
                <button id="createLotButton">Создать лот</button>
                <button id="myLotButton">Мои лоты</button>
            </div>
            <div class="item-list" id="itemList">${n||"Рынок пуст. Приходите позже."}</div>
          </div>
    `,fo),go()}const fo=()=>{document.getElementById("filterToggle").addEventListener("click",function(){const n=document.getElementById("filterContent"),e=document.getElementById("toggleIcon");n.classList.contains("active")?(n.classList.remove("active"),e.innerHTML="&#9660;"):(n.classList.add("active"),e.innerHTML="&#9650;")}),document.getElementById("filterBtn").addEventListener("click",function(){const n=document.getElementById("filterName").value.toLowerCase(),e=document.getElementById("filterLevel").value,t=document.getElementById("filterType").value.toLowerCase();document.querySelectorAll(".item-row").forEach(s=>{const r=s.getAttribute("data-name").toLowerCase(),a=s.getAttribute("data-level"),o=s.getAttribute("data-type").toLowerCase();let l=!0;n&&!r.includes(n)&&(l=!1),e&&a!==e&&(l=!1),t&&o!==t&&(l=!1),s.style.display=l?"flex":"none"})}),document.querySelectorAll(".buy-btn").forEach(n=>{n.addEventListener("click",function(){const e=n.getAttribute("data-lot-id");j.openConfirmModal(async()=>{await S("/market",{action:"buy",lot_id:e}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})})})}),document.getElementById("createLotButton").addEventListener("click",function(){ho(C.getSelfInfo().items)})};function an(){document.querySelectorAll(".expires[data-expires-at]").forEach(e=>{const t=e.getAttribute("data-expires-at");t&&(e.innerText=Qn(t))})}function go(){an(),setInterval(an,1e3)}const _o={draw:uo,get_lots:Jn};document.addEventListener("DOMContentLoaded",async function(){na(async()=>{let n,e;e=C.getSelfInfo(),document.addEventListener("contextmenu",v=>v.preventDefault());function t(){document.documentElement.style.setProperty("--vh",`${window.innerHeight*.01}px`)}window.addEventListener("resize",t),t(),C.getUserQuests()||C.setUserQuests(await S("/quest",{action:"get_user_quest"})),Oe.updateCountQuest(C.getUserQuests()),C.getUserMails()||C.setUserMails(await S("/mail",{action:"get_messages"})),ai.updateCountMail(C.getUserMails()),e||(e=await S("/player",{action:"get_self"}),C.setSelfInfo(e),localStorage.setItem("user_info",JSON.stringify(e))),e&&U.updateStatusBar(e),await Qt.applySettings(C.getSelfInfo().settings);const i=new tt({geometry:new Kt(Ie([0,0]))});i.setId(e.id),i.setProperties({typeObject:"player"});const s=[new Ye({image:new Gi({src:"/img/user.png",scale:1})}),new Ye({geometry:new vi(Ie([0,0]),O(C.getSelfInfo().interaction_radius,1.7)),stroke:new $s({color:"rgba(234,11,11,0.5)",width:1})})];i.setStyle(s);const r=new Re({features:[i]}),a=new pe({source:r,name:"player",className:"ol-layer__player",zIndex:4}),o=new Re,l=new pe({source:o,name:"points",className:"ol-layer__points",zIndex:3}),c=new Re,d=new Re,u=new pe({source:c,name:"lines",className:"ol-layer__lines",zIndex:2}),f=new pe({source:d,name:"lines",className:"ol-layer__lines",zIndex:2}),y=new Re,h=new pe({source:y,name:"regions",className:"ol-layer__regions",zIndex:1}),_=new Gr({className:"ol-layer__base",source:new kr}),T=new we({center:[0,0],zoom:19,minZoom:1,maxZoom:20,constrainResolution:!0}),w={NORMAL:165,CENTER:-10},p=new Re,L=new pe({source:p}),m=new Re,g=new pe({source:m});T.setProperties({offset:[0,w.NORMAL]});const P=new Da({target:"map",layers:[_,h,u,f,l,a,L,g],view:T,controls:zn().extend([new Oa]),interactions:$n({doubleClickZoom:!1})});let q;I(),"geolocation"in navigator&&navigator.geolocation.watchPosition(async({coords:v})=>{const E=v.longitude,x=v.latitude;N([E,x]),q=Ie([E,x]),document.querySelector("#toggle-follow").setAttribute("data-active",localStorage.getItem("follow")!=="false"),P.getProperties().is_first_watched||P.setProperties({is_first_watched:!0}),await S("/player",{action:"update_coordinates",longitude:E,latitude:x}).then(async()=>{}),await G(),P.getProperties().is_first_watched?await W:P.setProperties({is_first_watched:!0})},v=>{console.error("Geolocation API got an error:",v),v.code===1||v.code},{enableHighAccuracy:!0,maximumAge:0}),await S("/map/getRegions").then(v=>{U.addRegionsToMap(P,v,q)});function O(v,E=1/st("EPSG:3857",1,T.getCenter())){return v*E}function N(v){const E=Ie(v);i.getGeometry().setCoordinates(E),s.slice(1,3).forEach(x=>x.getGeometry().setCenter(E)),function(){const x=localStorage.getItem("follow")!=="false",{is_first_watched:A,ignore_follow:R}=P.getProperties();(A&&x&&!R||!A&&(x||!R))&&T.setCenter(E)}()}function I(){const v=new In({url:"https://{a-c}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"});_.setSource(v)}async function G(){const v=await S("/player",{action:"get_nearby_players"});p.clear(),v.forEach(E=>{z(E.player_id,E.longitude,E.latitude,"other_user.png")})}P.on("click",function(v){const E=new vt(v.coordinate);console.log("Координаты клика: ",E)});const M=new Ii({condition:pa,style:null});P.addInteraction(M),M.on("select",async function(v){v.preventDefault();const E=v.selected[0];if(!E)return;M.getFeatures().clear();const x=E.getId(),A=E.getProperties().typeObject;switch(vt(E.getGeometry().getCoordinates()),A){case"player":j.showModal("Информация об игроке",await Qa.drawPlayerWindow(x));break;case"resources":await S("/resource",{action:"get_resource",resource_id:x}).then(F=>{F&&(j.showModal(F==null?void 0:F.name,`
                            <p>${F==null?void 0:F.description}</p>
                            <button class="resource-mine">Начать добычу</button>
                        `),document.querySelector(".resource-mine")&&(document.querySelector(".resource-mine").onclick=async K=>{K.preventDefault(),K.target.disabled=!0;const B=await S("/resource",{action:"start_mine",resource_id:x});B!=null&&B.mine?await za(x,F.harvest_time_seconds,K):(U.createToast("Не удалось добыть. Попробуйте снова."),K.target.disabled=!1)}))});break;case"monsters":await Ga(x);break;case"portals":await no(x);break;case"npc":const R=await S("/npc",{action:"get_npc",npc_id:x});if(R){const F=R.id;j.showModal("Список квестов",Oe.generateQuestWindow([R],"accept")),document.querySelector(".button-access")&&(document.querySelector(".button-access").onclick=async K=>{await S("/quest",{action:"accept_quest",quest_id:F,object_id:x}),C.setUserQuests(await S("/quest",{action:"get_user_quest"})),Oe.updateCountQuest(C.getUserQuests()),j.closeModalHandler(K)}),document.querySelectorAll(".collapsible-header")&&document.querySelectorAll(".collapsible-header").forEach(K=>{K.addEventListener("click",()=>{K.parentElement.classList.toggle("open")})})}break}});function z(v,E,x,A){const R=Ie([E,x]),F=new tt({geometry:new Kt(R)});F.setId(v),F.setStyle(new Ye({image:new Gi({src:"/img/"+A,scale:1})})),F.setProperties({typeObject:"player"}),p.addFeature(F)}async function X(){let v=k(P);const E=U.transformCoordinates(v.nw),x=U.transformCoordinates(v.se),A=parseInt(v.zoom);n=await S("/points",{action:"view",nw:E,se:x,z:A}),m.clear(),n?n.forEach(function(R){const F=Ie([R.coordinates.lat,R.coordinates.lon]),K=new tt({geometry:new Kt(F)});K.setId("p"+R.id),K.setProperties({typeObject:R.type});let B;if(R.type==="other")B=new Ye({image:U.createCircleStyle("rgba(64,64,64,0.62)",10),text:U.createTextStyle(R)});else{const V=R.type==="monsters"?`/img/icons/points/monsters/${R.object_id}.png?${new Date().getDate()}`:R.type==="resources"?`/img/icons/points/resources/${R.object_id}.png?${new Date().getDate()}`:R.type==="portals"?`/img/icons/points/portals/${R.object_id}.png?${new Date().getDate()}`:`/img/icons/points/${R.type}.png?${new Date().getDate()}`;B=new Ye({image:U.createIconStyle(V),text:U.createTextStyle(R)})}K.setStyle(B),m.addFeature(K)}):m.clear()}let D;async function W(){clearTimeout(D),D=setTimeout(X,200)}function k(v){const E=T.calculateExtent(v.getSize()),x=vt(E.slice(0,2)).join(","),A=vt(E.slice(2,4)).join(","),R=T.getZoom();return{nw:x,se:A,zoom:R}}document.querySelector("#toggle-follow").addEventListener("click",v=>{v.preventDefault(),v.currentTarget.getAttribute("data-active")==="true"?v.currentTarget.setAttribute("data-active",!1):v.currentTarget.setAttribute("data-active",!0),localStorage.setItem("follow",v.currentTarget.getAttribute("data-active"))}),document.querySelector("#button-inventory").addEventListener("click",v=>{v.preventDefault(),j.showModal(C.getSelfInfo().name,U.drawCharacterWindows(C.getSelfInfo()))}),document.querySelector("#button-crafting").addEventListener("click",async v=>{v.preventDefault(),C.setUserRecipe(await S("/recipe",{action:"get_recipes"})),j.showModal("Мастерская",Qi.drawCraftingWindow(C.getUserRecipe())),document.querySelectorAll("[data-craft-run]").forEach(x=>{x.addEventListener("click",async A=>{A.preventDefault(),A.target.disabled=!0;const R=A.target.getAttribute("data-craft-run");await S("/recipe",{action:"make_recipe",recipe_id:R}).then(async F=>{F&&F.crafting_time&&F.crafting_time>0?await Qi.animatedCraft(R,F.crafting_time,A):A.target.disabled=!1})})});const E=document.querySelectorAll(".craft-button");E.forEach(x=>{x.addEventListener("click",()=>{E.forEach(R=>R.classList.remove("active")),x.classList.add("active");let A=x.getAttribute("data-item-type");document.querySelectorAll(".recipe-item").forEach(R=>{R.getAttribute("data-item-type")===A?R.style.display="flex":R.style.display="none"})})})}),document.querySelector("#button-settings").addEventListener("click",v=>{v.preventDefault(),j.showModal("Меню",`
                    <button id="button-profile">Профиль</button>
                    <button id="button-settings">Настройки игры</button>
                    <button id="button-feedback">Обратная связь</button>
                    <button id="button-logout">Выйти</button>
                `),document.querySelector("#button-logout").addEventListener("click",E=>{E.preventDefault(),U.logout()}),document.querySelector("#button-profile").addEventListener("click",E=>{E.preventDefault(),j.showModal("Профиль",Ji.drawProfileWindow(),()=>Ji.events())}),document.querySelector("#button-settings").addEventListener("click",E=>{E.preventDefault(),j.showModal("Настройки",Qt.drawSettingsWindow(C.getSelfInfo().settings),()=>Qt.events())}),document.querySelector("#button-feedback").addEventListener("click",E=>{E.preventDefault(),j.showModal("Обратная связь",tn.drawFeedbackWindow(),()=>tn.events())})}),document.querySelector("#button-quest").addEventListener("click",v=>{v.preventDefault(),j.showModal("Список квестов",Oe.generateQuestWindow(C.getUserQuests(),"view")),document.querySelectorAll(".collapsible-header")&&document.querySelectorAll(".collapsible-header").forEach(E=>{E.addEventListener("click",()=>{E.parentElement.classList.toggle("open")})}),document.querySelector(".cancel-quest-button")&&(document.querySelector(".cancel-quest-button").onclick=async E=>{E.preventDefault();let x=E.target.getAttribute("data-quest-id");j.openConfirmModal(async()=>{await S("/quest",{action:"delete_user_quest",quest_id:x}),C.setUserQuests(await S("/quest",{action:"get_user_quest"})),Oe.updateCountQuest(C.getUserQuests()),j.closeModalHandler(E)})}),document.querySelector(".complete-quest-button")&&(document.querySelector(".complete-quest-button").onclick=async E=>{E.preventDefault();let x=E.target.getAttribute("data-quest-id");await S("/quest",{action:"complete_quest",quest_id:x}),C.setUserQuests(await S("/quest",{action:"get_user_quest"})),Oe.updateCountQuest(C.getUserQuests()),e=await S("/player",{action:"get_self"}),C.setSelfInfo(e),j.closeModalHandler(E)})}),document.querySelector("#button-skill-progress").onclick=async v=>{var E;v.preventDefault(),j.showModal("Прогресс",eo.drawProgressWindow((E=C.getSelfInfo())==null?void 0:E.skill_progress))},document.querySelector("#button-stats-portal-close").onclick=async v=>{v.preventDefault(),j.showModal("Статистика",await co.getStats())},document.querySelector("#button-mail").onclick=async v=>{v.preventDefault(),await ai.getMail()},document.querySelector("#button-market").onclick=async v=>{v.preventDefault(),await _o.draw()},P.on("moveend",W),P.getView().on("change:resolution",W),await Dn.chat(!0)})});
